                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ( LOADBLOCK                                      <11/10/89>141) L64 ONLY FORTH ALSO DEFINITIONS                                 CR CR ." First word: AREA (ASTART)" CR CR                                                                                       XCREATE ASTART                                                     150 179 THRU  \ Area words                                      180 199 THRU  \ Window words                                    200 209 THRU  \ Screen words                                    210                                                                                                                                                                                          \ FORGET ASTART                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ( AREA NOTES                                     <11/10/89>150) EXIT ------------------------------------------------------                                                                     This file was taken from the IBM with no major changes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ( fah  ) ( AREA                                           <11/10/89>151)                                                                 RECORD: AREA \ holds places locations of places in window         2 FIELD: AR-NEXT  @L  !L  \ seg of next area (zero=end)         2 FIELD: AR-XPOS  @L  !L  \ area upper left x                   2 FIELD: AR-YPOS  @L  !L  \ area upper left y                   2 FIELD: AR-WID   @L  !L  \ area width                          2 FIELD: AR-HT    @L  !L  \ area heigth                         2 FIELD: AR-MIN   @L  !L  \ Area min value (inclusive)          2 FIELD: AR-MAX   @L  !L  \ Area max value (inclusive)          2 FIELD: AR-VAL   @L  !L  \ current area value                  1 FIELD: AR-ON    C@L C!L \ elapsed time to draw image          1 FIELD: AR-OFF   C@L C!L \ elapsed time to erase image                                                                                                                                                                                                       ( AREA cont                                      <11/10/89>152)                                                                   1 FIELD: AR-FLAG  B@L B!L \ area flags (bit# on stack)          1 FIELD: AR-TYPE  C@L C!L \ Area control type                   1 FIELD: AR-SUBT  C@L C!L \ Area sub type                       1 FIELD: AR-#CA   C@L C!L \ # cond/action pairs (0=none)         \ AR-#CA pairs of words follow this field                      0 FIELD: AR-TM NOOP NOOP  \ marker to start of AR-TITLE                                                                       REND \ text of string title string follows                                                                                                                                                                                                                                                                                                                                                                                                             ( fah  ) ( AREA notes                                     <11/10/89>153) EXIT                                                                                                                            Areas are referenced by a number (1-255) which is simply its    position within the linked list for the window.                 Area number 0 is returned if the point is not in a defined area of the current window.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ( fah  ) ( AR-FLAGS bit assignments                       <11/10/89>154)                                                                 \ 0 CONSTANT VISIBLE  \ T=control is visable                    \ 1 CONSTANT ENABLE   \ T=control is selectable                 \ 2 CONSTANT DIM      \ T=control is drawn dimmed               \ 5 CONSTANT KEYENAB  \ T=control can recognize keys            \ defined in RECORD.SCR                                                                                                         3 CONSTANT CALC-WID \ T=calc AR-WID based on WN-WID & AR-XPOS   4 CONSTANT NO-DEF   \ T=don't due default actions               6 CONSTANT LAST     \ T=last constrol in list                   7 CONSTANT 1ST      \ T=first control in list                                                                                                                                                                                                                                                                          ( fah  ) ( AR-PT-CA AR-PUT-CA AR-GET-CA                   <11/10/89>155)                                                                 \ for all CA words n=0 is the first pair                        : AR-PT-CA ( n -- seg adr, point to condition/action pair n )      DUP @@ AR-#CA U< NOT ABORT" AR-PT-CA: rng err"                  >R ^^ AR-#CA R> 4 * 1+ + ;                                                                                                   : AR-!CA ( c a n --, set condition/action pair n )                 AR-PT-CA D!L ;                                                                                                               : AR-@CA ( n -- c a, get condition/action pair n )                 AR-PT-CA D@L ;                                                                                                                                                                                                                                                                                                      ( fah  ) ( AR-TOFS AR-TITLE                               <11/10/89>156)                                                                 : AR-TSIZE ( -- n, size of area not including title )              [ F[ AR-#CA 1+ ] LITERAL @@ AR-#CA 4 * + ;                                                                                   : AR-TITLE ( -- seg adr, compute adr of title string )             ^^ AR-TM @@ AR-#CA 4 * + ;                                                                                                   EXIT ----------------------------------------------------------                                                                 Since the condition/action list is a variable length structure  the address of the title string must be computed based on the   number of pairs.  It is legal for AR-#CA to be zero                                                                                                                                                                                                    ( fah  ) ( AR-NUM-CA                                      <11/10/89>157)                                                                 : AR-NUM-CA \ n --, increase allocation of area to allow room      \ for n condition pairs (see AR-TLEN)                           \ **** Sets AR-TITLE to 1 byte of zero ****                     !! AR-#CA              \ set field                              AR-TSIZE 1+            \ offset to start of title               GETHAN AREA HRESIZE    \ make area that size                    0 AR-TITLE C!L         \ set null title                      ;                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( fah  ) ( AR-TLEN AR-TITLE-SIZE                          <11/10/89>158)                                                                 : AR-TLEN ( n --, reserve room for a n character string )          1+ AR-TSIZE +   \ new total length                              GETHAN AREA HRESIZE ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               ( fah  ) ( AR-LAST                                        <11/10/89>159)                                                                 : AR-LAST \ -- phan lhan, return adress of last two AREAS          \ phan=segment of next to last AREA (0=only one area)           \ lhan=segment of last AREA (0=no areas)                        @@ WN-AREAS DUP                     \ any areas at all?         IF DUP SETHAN AREA @@ AR-NEXT ?DUP  \ more than one area?        IF DUP SETHAN AREA                                               BEGIN @@ AR-NEXT ?DUP             \ find end of the chain       WHILE DUP SETHAN AREA ROT DROP                                  REPEAT                                                         ELSE 0 SWAP                        \ 1 area, no prev            THEN                                                           ELSE 0 THEN                                                     ;                                                                                                                   ( fah  ) ( AR-ADD                                         <11/10/89>160)                                                                 : AR-ADD ( han --, add area at seg to end of chain, zero next )    DUP SETHAN AREA 0 !! AR-NEXT \ make end of chain                GETHAN AREA >R                                                  AR-LAST SWAP DROP ?DUP                                          IF SETHAN AREA !! AR-NEXT  \ link into chain                    ELSE !! WN-AREAS THEN      \ point to first in list             R> SETHAN AREA ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ( fah  ) ( <AR-ALLOC-SET> AR-ALLOC-SET                    <11/10/89>161)                                                                 : <AR-ALLOC-SET> ( -- )                                            0 !! AR-TYPE 3 ^^ AR-FLAG C!L \ set default values              0 !! AR-#CA 0 AR-TITLE C!L \ zero control fields                @@ WN-XPOS  !! AR-XPOS  @@ WN-YPOS !! AR-YPOS                   @@ WN-WID   !! AR-WID   @@ WN-HT   !! AR-HT                     0 !! AR-VAL 0 !! AR-MIN 1 !! AR-MAX                             0 !! AR-SUBT 0 !! AR-ON 0 !! AR-OFF ;                                                                                        : AR-ALLOC-SET ( han -- )                                          AR-ADD \ add to chain, point to new                             <AR-ALLOC-SET> ;                                                                                                                                                                                                                                    ( fah  ) ( AR-ALLOC AR-1ALLOC                             <11/10/89>162)                                                                 : AR-ALLOC ( -- t/f, T=AREA points to new, F=can't alloc )        \ defaults area to current window size, free with AR-FREE       AREA 1+ HALLOC                                                  AR-ALLOC-SET                                                    1 ( ok )                                                      ;                                                                                                                                                                                               : AR-SIZE ( -- n, return byte length of current area )             GETHAN AREA HBLK-SIZE ;                                                                                                                                                                                                                                                                                             ( fah  ) ( AR-FREE                                        <11/10/89>163)                                                                 : AR-FREE ( --, free last area for WINDOW, point area to prev )    AR-LAST ( prev last -- ) ?DUP \ any at all?                     IF <HFREE> ( prev ) ?DUP      \ release it, any AREAS before     IF SETHAN AREA 0 !! AR-NEXT  \ yes, it is now last              ELSE 0 !! WN-AREAS           \ no, all areas free'd              0 SETHAN AREA                                                  THEN                                                           ELSE DROP                                                       THEN ;                                                                                                                                                                                                                                                                                                                                                                              ( fah  ) ( <AR-FREE-ALL> AR-FREE-ALL                      <11/10/89>164)                                                                 : <AR-FREE-ALL> ( han --, free all areas starting at seg )         ( WARNING: AREA is left dangling! )                             BEGIN ?DUP                                                      WHILE DUP SETHAN AREA @@ AR-NEXT SWAP <HFREE>                   REPEAT ;                                                                                                                     : AR-FREE-ALL ( --, free all areas for WINDOW )                    \ zeros WN-AREAS, leaves AREA undefined!                        @@ WN-AREAS     \ do nothing if no areas defined                <AR-FREE-ALL>                                                   0 SETHAN AREA                                                   0 !! WN-AREAS ;                                                                                                                                                                     ( fah  ) ( IN-AREA?                                       <11/10/89>165)                                                                 : IN-AREA? ( x y -- T/F, return T if x y in AREA )                 @@ AR-YPOS - @@ AR-HT U< SWAP                                   @@ AR-XPOS - @@ AR-WID U< AND ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ( fah  ) ( <FIND-AREA>                                    <11/10/89>166)                                                                 : <FIND-AREA> \ n seg -- <n' seg' 0> <n' 1>, 1=area found          SETHAN AREA               \ point to area                       ENABLE @@ AR-FLAG         \ is it enabled?                      IF @EVT-XY IN-AREA?       \ and in the area?                     IF ( n ) 1 EXIT          \ yes, we found it                     THEN                                                           THEN                                                            1+ @@ AR-NEXT 0           \ inc area number, point to next   ;                                                                                                                                                                                                                                                                                                                                                                                      ( fah  ) ( FIND-AREA                                      <11/10/89>167)                                                                 : FIND-AREA \ -- n/0, get AREA # containing event coord            ( area 1 is the first AREA in the list )                        1 @@ WN-AREAS             \ start with first area               BEGIN ?DUP ( 0= NOT )     \ while more                          WHILE <FIND-AREA>         \ check this area                      IF EXIT THEN             \ exit if we have an answer           REPEAT                                                          DROP 0                    \ return not found                 ;                                                                                                                                                                                                                                                                                                                                                                                      ( fah  ) ( AR-LOC AR-FILL AR-SET                          <11/10/89>168)                                                                 : AR-LOC ( x y w h --, set current area location )                 !! AR-HT !! AR-WID !! AR-YPOS !! AR-XPOS ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ( fah  ) ( AR-HIDE-MOUSE                                  <11/10/89>169)                                                                 STUB: AR-HIDE-MOUSE ( --, conditional hide if in area )                                                                         EXIT ------- MOUSE NOT SUPPORTED ---------                        \ still must call SHOW-MOUSE to balance call                     @@ AR-XPOS 0 MAX GX->MX                                         @@ AR-YPOS 0 MAX                                                @@ AR-XPOS @@ AR-WID + DISP-WID 1- MIN GX->MX                   @@ AR-YPOS @@ AR-HT + DISP-HT 1- MIN                            ?HIDE-MOUSE ;                                                                                                                                                                                                                                                                                                                                                                       ( fah  ) ( AR-FILL AR-XOR                                 <11/10/89>170)                                                                 : AR-FILL                                                          @@ AR-XPOS @@ AR-YPOS                                           OVER @@ AR-WID 1- +                                             OVER @@ AR-HT 1- + BAR ;                                                                                                     : AR-XOR ( -- , xor current area )                                 AR-HIDE-MOUSE @GR-MODE 0 GR-MODE                                AR-FILL GR-MODE SHOW-MOUSE ;                                                                                                                                                                                                                                                                                                                                                                                                                        ( fah  ) ( AR-FLASH                                       <11/10/89>171)                                                                 : AR-FLASH ( n d -- , flash area n times, d is delay between )     ?DUP                                                            IF @GR-MODE >R AR-HIDE-MOUSE 0 GR-MODE 0                         DO AR-FILL DUP DELAY AR-FILL DUP DELAY LOOP                     DROP R> GR-MODE SHOW-MOUSE                                     ELSE DROP THEN                                               ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( fah  ) ( AR-NUM                                         <11/10/89>172)                                                                 : AR-NUM ( -- n/0, return area number of AREA or zero)             ( n=0 no match in this window, 1=first area 2=2nd... )          GETHAN AREA >R                                                  @@ WN-AREAS DUP                                                 IF SETHAN AREA 1                                                 BEGIN GETHAN AREA R@ =                                           IF R> SETHAN AREA EXIT THEN                                     1+ @@ AR-NEXT ?DUP                                             WHILE SETHAN AREA                                               REPEAT                                                         THEN                                                            R> SETHAN AREA ;                                                                                                                                                                    ( fah  ) ( AR-NUM-SET                                     <11/10/89>173)                                                                 : AR-NUM-SET \ N -- , set AREA to n'th area (1=first)              @@ WN-AREAS DUP 0= ABORT" AR-NUM-SET: no AREA's"                SETHAN AREA                                                     BEGIN DUP 1 >                                                   WHILE @@ AR-NEXT ?DUP                                            IF SETHAN AREA THEN                                             1-                                                             REPEAT                                                          DROP ;                                                                                                                                                                                                                                                                                                                                                                              ( fah  ) ( AR-COPY                                        <11/10/89>174)                                                                 : AR-COPY ( -- T/F, T=area copied, F=can't alloc )                 ( add a copy of the current area to end of chain )              AR-SIZE HALLOC ?DUP                                             IF ( han ) DUP PT-HALLOC 0 ( dest pointer )                      GETHAN AREA PT-HALLOC 0 ( source pointer )                      DSWAP AR-SIZE CMOVEL     \ copy area data to new                ( han ) AR-ADD           \ add to window chain                  1 ( O.K. )                                                     ELSE 0 ( fail )                                                 THEN ;                                                                                                                                                                                                                                                                                                              ( fah  )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ( WINDOW NOTES                                   <11/10/89>180) EXIT ------------------------------------------------------                                                                     This file was taken from the IBM with no major changes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ( fah  ) ( -WINDOW-                                       <11/10/89>181)                                                                 ONLY FORTH ALSO DEFINITIONS                                                                                                       VOCABULARY -WINDOW- IMMEDIATE                                                                                                 ONLY FORTH ALSO -WINDOW- ALSO FORTH DEFINITIONS                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ( fah  ) ( WN-TINIT                                       <11/10/89>182) FORTH DEFINITIONS                                                                                                               : WN-TINIT ( -- )                                                  \ initialize text parameters                                    0 TX-MODE 0 !! WN-TFONT                                         DISP-CLRS 1- TX-COLOR 0 TX-ITAL                                 1 TX-DX 1 TX-DY 0 TX-LHT 7 TX-BLHT                              DISP-CLRS 1- !! WN-THFACE 0 !! WN-TEFACE                        DISP-CLRS 2/ 1- !! WN-TDFACE ;                                                                                                                                                                                                                                                                                                                                                                                                                      ( fah  ) ( WN-INIT                                        <11/10/89>183) FORTH DEFINTITIONS                                                                                                              : WN-INIT \ --, initialize window parameters to "default"          DISP-WID !! WN-CWID DISP-HT  !! WN-CHT   \ save disp res        0 !! WN-TYPE 0 !! WN-AREAS 0 !! WN-DATA  \ clear fields         0 !! WN-XPOS 0 !! WN-YPOS                \ default to full..    DISP-WID !! WN-WID DISP-HT !! WN-HT      \ size window          3 ^^ WN-FLAG C!L \ set to NOT DIM, ENABLE, VISIBLE              1 !! WN-FADE \ initialize drawing parameters                    0 !! WN-PATTERN 0 !! WN-GDOT 0 !! WN-PL 0 !! WN-BG              DISP-CLRS 1- !! WN-HCOLOR 0 !! WN-BCOLOR                        DISP-CLRS 2/ 1- !! WN-DCOLOR 0 !! WN-ECOLOR 0 !! WN-FRAME       WN-TINIT ;                                                                                                                                                                          ( fah  ) ( WN-ALLOC                                       <11/10/89>184) FORTH DEFINITIONS                                                                                                               : WN-ALLOC ( -- t/f, T=WINDOW points to new, F=can't alloc )      \ sets fixed fields, if F=WINDOW not changed                    WINDOW HALLOC SETHAN WINDOW                                     WN-INIT 1 ( ok ) ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ( fah  ) ( WN-FREE                                        <11/10/89>185) FORTH DEFINITIONS                                                                                                               : WN-FREE ( --, free current window )                              \ frees all areas in window, set WINDOW to NULL if no prev      \ set WN-HEAD to vaule of WINDOW                                AR-FREE-ALL                                                     @@ WN-DATA ?DUP ( any ALLOC'd data to free? )                   IF <HFREE> THEN                                                 GETHAN WINDOW <HFREE>                                           0 SETHAN WINDOW                                              ;                                                                                                                                                                                                                                                                                                                      ( fah  ) ( IN-WINDOW?                                     <11/10/89>186) FORTH DEFINITIONS                                               EXIT ------------- NOT NEEDED ----------------                                                                                  : IN-WINDOW? ( x y -- T/F, return T if x y in WINDOW )             @@ WN-YPOS - @@ WN-HT U< SWAP                                   @@ WN-XPOS - @@ WN-WID U< AND ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ( SCAN-EMPTY ADD-SCAN                            <11/10/89>187) -WINDOW- DEFINITIONS                                            EXIT ------------- NOT NEEDED ----------------                  0 CONSTANT #FIND  \ # windows in FIND-LIST                                                                                      CREATE FIND-LIST ( segment of windows to scan in ACTIONS )         20 ALLOT                                                                                                                     : ^FIND# ( n -- adr, point to table, N=1 is first )                DUP 1 #FIND WITHIN NOT ABORT" ^FIND#: rng err"                  1- 2* FIND-LIST + ;                                                                                                          : @FIND# ( n -- seg, return seg of window n, 1=first )             ^FIND# @ ;                                                                                                                                                                                   ( SCAN-EMPTY ADD-SCAN                            <11/10/89>188) FORTH DEFINITIONS                                               EXIT ------------- NOT NEEDED ----------------                                                                                  : FIND-EMPTY ( --, empty actions scan buffer )                     0 TO #FIND ;                                                                                                                 : ADD-FIND ( seg -- add window to scan list )                      #FIND 10 U< NOT ABORT" ADD-FIND: overflow!"                     #FIND 1+ DUP TO #FIND ^FIND# ! ;                                                                                                                                                                                                                                                                                                                                                                                                                             ( FIND-WINDOW                                    < 8/21/89> 15) FORTH DEFINITIONS                                               EXIT ------------- NOT NEEDED ----------------                                                                                  : FIND-WINDOW \ -- T/F, find WINDOW containing event coord        0 ( default answer ) #FIND ?DUP                                 IF 0                                                             DO I 1+ @FIND# SETHAN WINDOW                                    ENABLE @@ WN-FLAG       \ is it enabled?                        IF @EVT-XY IN-WINDOW?   \ in this window?                        IF 1+ LEAVE THEN       \ yes, exit pointing to it              THEN                                                            LOOP                                                           THEN                                                          ;                                                                                                                               ( WN-LOC                                         <11/10/89>190) FORTH DEFINITIONS                                                                                                               : WN-LOC ( x y w h --, set current window location )               !! WN-HT !! WN-WID !! WN-YPOS !! WN-XPOS ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ( fah  ) ( WN-FILL                                        <11/10/89>191) FORTH DEFINITIONS                                                                                                               : WN-FILL ( --, fill window with current color/mode )              @@ WN-XPOS @@ WN-YPOS                                           OVER @@ WN-WID 1- +                                             OVER @@ WN-HT 1- + BAR ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ( WN-ATTRIB-SET WN-SET                           <11/10/89>192) FORTH DEFINITIONS                                               : WN-ATTRIB-SET ( -- , set sys to match attributes in WINDOW )     @@ WN-GDOT  GR-DOT     @@ WN-PATTERN GR-PATTERN                 @@ WN-TFONT TX-FONT    @@ WN-TMODE TX-MODE                      @@ WN-TX    GX !       @@ WN-TY    GY !                         @@ WN-TFG   TX-COLOR   @@ WN-TITAL TX-ITAL                      @@ WN-TDX   TX-DX      @@ WN-TDY   TX-DY                        @@ WN-TLHT  TX-LHT     @@ WN-TBLHT TX-BLHT                   ;  \ WN-AUX is available for general use                                                                                        : WN-SET ( han --, set WINDOW to point to window at SEG )       \ use when making the WINDOW current display window                SETHAN WINDOW WN-ATTRIB-SET ;                                                                                                                                                       ( fah  ) ( <UPDATE-TXY> WN-PCOPY                          <11/10/89>193) FORTH DEFINITIONS                                               EXIT ------------- NOT NEEDED ----------------                                                                                  : <UPDATE-TXY> ( --, copy text cursor to window pos )              GX @ !! WN-TX GY @ !! WN-TY ;                                                                                                REVECTOR <UPDATE-TXY> INTO UPDATE-TXY                                                                                           : WN-PCOPY ( seg --, copy window params to cur window  )           [ F[ WN-HCOLOR ] LITERAL \ source seg offs                      ^^ WN-HCOLOR \ dest seg offs                                    [ WINDOW F[ WN-HCOLOR - ] LITERAL \ len                         BMOVEL ;                                                                                                                                                                                     ( WN-INSIDE? WN-IS?                              < 9/20/88> 16) FORTH DEFINITIONS                                               EXIT ------------- NOT NEEDED ----------------                                                                                  : WN-INSIDE? ( han -- T/F, check if event in window at seg )       GETHAN WINDOW >R \ preserves old value of WINDOW                SETHAN WINDOW @EVT-XY IN-WINDOW?                                R> SETHAN WINDOW ;                                                                                                           : WN-IS? ( han -- T/F, T=WINDOW is seg )                           GETHAN WINDOW = ;                                                                                                                                                                                                                                                                                                                                                                            ( WN-XOR                                         < 9/20/88> 17) FORTH DEFINITIONS                                               EXIT ------------- NOT NEEDED ----------------                                                                                  : WN-XOR ( -- , xor current window )                              HIDE-MOUSE @GR-MODE 0 GR-MODE                                   WN-FILL GR-MODE SHOW-MOUSE ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ( WN-BOUNDS WN-SAVE-UNDER                        <11/10/89>196) FORTH                                                                                                                           : WN-BOUNDS \ -- x1 y1 x2 y2, get window params                    ( defines box inside the window )                               @@ WN-XPOS @@ WN-YPOS                                           OVER @@ WN-WID + 1-                                             OVER @@ WN-HT + 1- ;                                                                                                         : WN-SAVE-UNDER \ -- seg, save screen under window                 WN-BOUNDS SAVE-AREA                                             DUP 0= ABORT" WN-SAVE-UNDER: mem err" ;                                                                                      : WN-RESTORE \ seg --, restore window contents                     REST-AREA ;                                                                                                         ( fah  )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ( SCREEN NOTES                                   <11/10/89>200) EXIT ------------------------------------------------------                                                                     This file was taken from the IBM with no major changes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ( fah  ) ( SCREEN                                         <11/10/89>201) RECORD: SCREEN \ holds general info pointers/to windows           1 FIELD: SCR-VE    C@L C!L  \ visual effect when drawing scr    1 FIELD: SCR-BG    C@L C!L  \ background for this screen        1 FIELD: SCR-PL   SC@L C!L  \ palette for this scren            1 FIELD: SCR-BLINK C@L C!L  \ blink speed (menu items etc)      1 FIELD: SCR-FLASH C@L C!L  \ flash speed (cursors etc)         1 FIELD: SCR-AWIN  C@L C!L  \ Apple window position             2 FIELD: SCR-LAST   @L  !L  \ number of previous screen or 0    2 FIELD: SCR-NEXT   @L  !L  \ number of next screen or 0        1 FIELD: SCR-#BRA  C@L C!L  \ number of branch screens          1 FIELD: SCR-#WIN  C@L C!L  \ number of windows                 0 FIELD: SCR-DATA NOOP NOOP \ to find adr where data starts   \ SCR-#BRA words containing # of branch screens (or none)       \ SCR-#WIN words containing # of windows in screen (or none)    REND                                                   ( fah  ) ( ^SCR-BRA ^SCR-WIN                              <11/10/89>202)                                                                 : ^SCR-BRA \ n -- seg adr, return pointer to branch n (0=first)    DUP 0 @@ SCR-#BRA WITHIN NOT ABORT" ^SCR-BRA: rng err"          2* ^^ SCR-DATA ROT + ;                                                                                                       : ^SCR-WIN \ n -- seg adr, return pointer to window n (0=first)    DUP 0 @@ SCR-#WIN WITHIN NOT ABORT" ^SCR-WIN: rng err"          @@ SCR-#BRA + 2*   \ skip over branches                         ^^ SCR-DATA ROT + ;                                                                                                                                                                                                                                                                                                                                                                                                                                 ( fah  ) ( SCR-ALLOC                                      <11/10/89>203)                                                                 : SCR-ALLOC ( -- T/F, T=new empty screen record allocated )        SCREEN HALLOC DUP                                               IF SETHAN SCREEN                                                 0 !! SCR-#BRA                                                   0 !! SCR-#WIN \ clear fields                                    1 !! SCR-AWIN \ default to middle position                      1 ( ok! )                                                      THEN                                                         ;                                                                                                                                                                                                                                                                                                                                                                                      ( fah  ) ( SCR-ADJUST                                     <11/10/89>204)                                                                 : SCR-ADJUST \ -- T/F, adjust screen allocation T=adjusted         \ make room to hold SCR-#BRA, and SCR-#WIN                      \ LOCATION OF 'SCREEN' WILL PROBABLY CHANGE                     @@ SCR-#BRA @@ SCR-#WIN + 2*                                    [ F[ SCR-DATA ] LITERAL +  \ new # bytes for record             GETHAN SCREEN HRESIZE                                           1 ( ok ) ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ( fah  )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ( CTRUN NOTES                                    <11/10/89>210) EXIT ------------------------------------------------------                                                                     This file was taken from the IBM with no major changes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ( fah  ) ( -CTRUN-                                        <11/10/89>211)                                                                 ONLY FORTH ALSO DEFINITIONS                                                                                                       VOCABULARY -CTRUN- IMMEDIATE                                                                                                  ONLY FORTH ALSO -CTRUN- ALSO FORTH DEFINITIONS                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ( fah  ) ( CONTROL global variables                       <11/10/89>212) FORTH DEFINITIONS                                                                                                                 0 CONSTANT TRACKING? \ true while in CT-WATCH                   0 CONSTANT STOP-SCAN? \ true stop scanning scan list            0 CONSTANT 1ST-PASS?  \ cleared after every ACTIONS             0 CONSTANT NEW-SCR?   \ set true when drawing screen                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ( CONTROL global variables                       <11/10/89>213) FORTH DEFINITIONS                                                                                                               EXIT ------ MOUSE/TRACKING stuff -----------                      0 CONSTANT CT-PART   \ current control part                     0 CONSTANT CT-VALNEW \ new value for field (for track words)    0 CONSTANT CT-MINNEW \ new value for field (for track words)    0 CONSTANT CT-FUNC   \ 0=1stin 1=2ndin 2=move 3=out 4=cleanup   0 CONSTANT CT-VALID  \ set if still in dial for CT-PART         3 CONSTANT MN-#FLASH \ number of flashes on selection           1 CONSTANT MN-FDELAY \ delay between flashes                    0 CONSTANT DRAW-WIN? \ true while drawing window                                                                                                                                                                                                                                                                     ( fah  ) ( DEC-DEATH-COUNT                                <11/10/89>214)                                                                 : DEC-DEATH-COUNT                                                  <DEC-DEATH-COUNT>                                               \ re-access current records so they won't be purged             GETHAN WINDOW SETHAN WINDOW                                     GETHAN AREA SETHAN AREA ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ( fah  ) ( CT-SET-TITLE CT-TITLE 'FORTH                   <11/10/89>215) FORTH                                                                                                                           : CT-SET-TITLE \ adr cnt --, set title without adj allocation      DUP >R AR-TITLE C!L                                             GET:CS SWAP AR-TITLE 1 LA+ R> BMOVEL ;                                                                                       : CT-TITLE \ adr cnt --, set control title to string               DUP AR-TLEN CT-SET-TITLE ;                                                                                                   EXIT -----------------------------------------------------      : 'FORTH ( adr -- <pfa>, find word in FORTH vocab )                [ 'NFA FORTH ] LITERAL VOC-TOP <<SPLIT-FIND> NOT                ABORT" Not found in FORTH!"                                     ( count byte ) DROP ;                                                                                               ( fah  ) ( CONTROL CT-TSIZE                               <11/10/89>216) FORTH DEFINITIONS                                                                                                               : CONTROL ( n --, execute routine n in control )                   QUIT ; \ vector planted when defined in CONTROL.SCR                                                                          : CT-TSIZE ( -- run area title through CSIZE )                     CS-INIT AR-TITLE COUNTL ?DUP                                    IF 0                                                             DO COUNTL DUP 32 <                                               IF DROP ELSE CSIZE THEN                                        LOOP                                                           ELSE BL CSIZE THEN \ make empty return true height              DDROP ;                                                                                                                                                                             ( fah  ) ( CT-DRAW CT-DRAW-VAL                            <11/10/89>217) FORTH DEFINITIONS                                                                                                               : CT-DRAW \ --, draw entire control                                VISIBLE @@ WN-FLAG \ only execute if window is visible          IF 1 CONTROL THEN ;                                                                                                          : CT-DRAW-VAL \ --, draw "value" control part                      VISIBLE @@ WN-FLAG \ only execute if window is visible          IF 2 CONTROL THEN ;                                                                                                                                                                                                                                                                                                                                                                                                                                 ( fah  ) ( CT-DO-FUNC CT-DO-FUNC#                         <11/10/89>218) EXIT -------------------------------------------------------    FORTH DEFINITIONS                                                                                                               : CT-DO-FUNC \ --, execute control function CT-FUNC                3 CONTROL ;                                                                                                                  : CT-DO-FUNC# \ n -- , set CT-FUNC call CT-FUNC                    TO CT-FUNC CT-DO-FUNC ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( CT-FIND CT-FIND-DIAL                           <12/ 6/88> 11) EXIT -------------------------------------------------------    FORTH DEFINITIONS                                                                                                               : CT-FIND \ --, set CT-PART EVENT is pointing to (0=none)          ENABLE @@ WN-FLAG \ only execute if window is enabled           IF CT-TSIZE 4 CONTROL                                           ELSE 0 TO CT-PART 0 TO CT-VALID                                 THEN ;                                                                                                                       : CT-FIND-DIAL \ --, set CT-VALID if EVENT in CT-PART for dial     ENABLE @@ WN-FLAG \ only execute if window is enabled           IF 5 CONTROL                                                    ELSE 0 TO CT-VALID                                              THEN ;                                                                                                                       ( FADE-REGN AR-FADE-REGN                         <11/10/89>220) FORTH DEFINITIONS                                                                                                               CREATE FADE-REGN \ 0=bwidth , 2=nlines , 4=bstart , 6=lstart,     8 ALLOT                                                                                                                       : AR-FADE-REGN ( -- , set fade region to match area )              @@ AR-WID PIX/BYTE /MOD SWAP 0= NOT + FADE-REGN !               @@ AR-HT FADE-REGN 2+ !                                         @@ AR-XPOS PIX/BYTE /MOD FADE-REGN 4 + !                        0= NOT FADE-REGN +!                                             @@ AR-YPOS FADE-REGN 6 + ! ;                                                                                                                                                                                                                                                                                        ( fah  ) ( FX-RESTORE                                     < 5/20/89> 13) FORTH DEFINITIONS                                                                                                               CODE FX-RESTORE \ -- , restore FADE-REGN from save:seg              SI PUSH DS PUSH ES PUSH                                         DX, FADE-REGN 6 + MOV                                           ES, CRTSEG MOV                  \ ES=screen segment             {save:seg} CALL DS, AX MOV      \ DS=buffer's segment           AH, CS: FADE-REGN 2+ MOV  \ AH=number of lines                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  BEGIN DI, DX MOV {yaddr} CALL                                     BX, CS: FADE-REGN 4 + ADD                                       SI, BX MOV DI, BX MOV                                           CX, CS: FADE-REGN MOV BYTE REP MOVS                             DX INC AH DEC                                                UNTIL=                                                          ES POP DS POP SI POP NEXT-JMP C;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( FX-RESTORE -- CGA version                      < 5/20/89> 13) FORTH CGA-EXIT \ -------------------------------                CODE FX-RESTORE \ -- , restore FADE-REGN from save:seg              SI PUSH DS PUSH ES PUSH                                         DX, FADE-REGN 6 + MOV                                           ES, CRTSEG MOV                  \ ES=screen segment             {save:seg} CALL DS, AX MOV      \ DS=buffer's segment           AH, CS: FADE-REGN 2+ MOV  \ AH=number of lines                  BEGIN DI, DX MOV {yaddr} CALL                                     BX, CS: FADE-REGN 4 + ADD                                       SI, BX MOV DI, BX MOV                                           CX, CS: FADE-REGN MOV BYTE REP MOVS                             DX INC AH DEC                                                UNTIL=                                                          ES POP DS POP SI POP NEXT-JMP C;                                                                                             ( FX-RESTORE -- EGA version                      < 5/20/89> 14) FORTH EGA-EXIT \ -------------------------------                                                                                CODE FX-RESTORE \ -- , restore FADE-REGN from save:seg              SEQ-PORT 2 15 OUTIND            \ BP-MASK=15                    G12-PORT 8 0 OUTIND             \ BIT-MASK=0                    SI PUSH DS PUSH ES PUSH                                         DX, FADE-REGN 6 + MOV           \ start line                    ES, ' EGA-SEG MOV               \ ES=screen segment             DS, ' EGA-OS-SEG MOV            \ DS=source segment             CX, CS: FADE-REGN 2+ MOV        \ CX=number of lines            CLI \ suppress processor interupts                                                                                          \ More...                                                                                                                                                                                       ( FX-RESTORE -- EGA version cont                 < 5/20/89> 15) EGA-EXIT \ -------------------------------                                                                                         DO CX PUSH                                                        DI, DX MOV {yaddr} CALL                                         BX, CS: FADE-REGN 4 + ADD                                       SI, BX MOV DI, BX MOV                                           CX, CS: FADE-REGN MOV BYTE REP MOVS                             DX INC CX POP                                                 LOOP                                                            STI \ enable interupts                                          G12-PORT 8 255 OUTIND           \ BIT-MASK=255                  ES POP DS POP SI POP NEXT-JMP C;                                                                                                                                                                                                                             ( CT-DISAB                                       <10/ 5/89> 16)                                                                                                                                 : CT-DISAB                                                          0 VISIBLE !! AR-FLAG                                            0 KEYENAB !! AR-FLAG ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( ELAPSED CT-DEF-ACT ER-CONTROL DR-CONTROL       < 7/ 2/89> 17) FORTH                                                            0 CONSTANT ELAPSED     \ ticks since STARTTIME                                                                                 : CT-DEF-ACT ( --, run any control specific default actions )     \ @@ AR-TYPE 14 = NOT                                         ; \ IF 6 CONTROL THEN ;                                                                                                         : ER-CONTROL ( --, copy screen under control from SAVE:SEG )       AR-FADE-REGN FX-RESTORE                                         0 VISIBLE !! AR-FLAG ;                                                                                                       : DR-CONTROL ( --, draw the control, set visible )                 1 VISIBLE !! AR-FLAG CT-DRAW ;                                                                                                                                                               ( ?ON-TIME                                       < 7/ 2/89> 18) FORTH                                                                                                                           : ?ON-TIME ( --, see if it time to turn on )                      VISIBLE @@ AR-FLAG NOT        \ area is not drawn               IF @@ AR-OFF                  \ off time specifed?               IF ELAPSED @@ AR-OFF <       \ still before off time?           ELSE 1 THEN                  \ no off time, draw it             IF ELAPSED @@ AR-ON < NOT    \ and its after time to draw?       IF DR-CONTROL               \ draw the stupid thing              1 KEYENAB !! AR-FLAG                                           THEN                                                           THEN                                                           THEN ;                                                                                                                                                                                        ( ?OFF-TIME                                      < 7/ 2/89> 19)                                                                 : ?OFF-TIME ( --, see if it time to turn off )                    VISIBLE @@ AR-FLAG           \ areaa its drawn                  IF ELAPSED @@ AR-OFF < NOT   \ and its time to erase!            IF ER-CONTROL               \ copy bg over contol                0 KEYENAB !! AR-FLAG                                           THEN                                                           THEN ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ( GET-DATA                                       <10/ 9/89> 20)                                                                 CREATE HAS-DATA \ set to 1 if control type has data                0 C, 0 C, 0 C, 0 C, 0 C, 0 C, 0 C, 0 C, 0 C, 0 C, \ 0-9         0 C, 0 C, 0 C, 0 C, 0 C, 0 C, 0 C, 0 C, 1 C, 1 C, \ 10-19       1 C, 0 C, 0 C, 0 C, 0 C, 0 C, 0 C, 0 C, 0 C, 0 C, \ 20-29                                                                    : GET-DATA \ -- make sure data for control is resident            @@ AR-TYPE HAS-DATA + C@ \ this have data?                      IF \ ^DATA will load if not resident                             AR-TITLE D@L ^DATA DDROP                                       THEN ;                                                                                                                                                                                                                                                                                                                        ( DEF-ACTS                                       < 6/17/89> 21) FORTH                                                                                                                           : DEF-ACTS ( --, execute any default system actions )              NEW-SCR? IF GET-DATA THEN                                       NO-DEF @@ AR-FLAG NOT     \ run default actions?                IF \ run any control specific defs                               CT-DEF-ACT                                                       \ run auto timing controls                                     @@ AR-ON 0> IF ?ON-TIME THEN                                    @@ AR-OFF 0> IF ?OFF-TIME THEN                                 THEN                                                         ;                                                                                                                                                                                                                                                               ( DO-ACTION                                      < 8/21/89> 22)                                                                 : DO-ACTION \ n -- T/F, T=skip next cond/action                    AR-@CA ( cond act -- ) DUP                                      [ ' AND CFA ] LITERAL =       \ "AND" action?                   IF ( act ) DROP                                                  ?EXECUTE NOT                 \ did 1st cond return false?      ELSE \ not "AND" action execute as normal                        SWAP ( cond ) ?EXECUTE       \ did cond return true?            IF ( act ) ?EXECUTE          \ yes, do action                   ELSE DROP THEN               \ no, drop action                  0 ( don't skip next )                                          THEN ;                                                                                                                                                                                                                                                       ( AR-ACTION                                      <11/29/88> 23) FORTH                                                                                                                           : <AR-ACTION> \ scan AREA for something to do                      0 TO STOP-SCAN?  \ start with flag disabled                     DEF-ACTS @@ AR-#CA ?DUP                                         IF CT-PART >R \ any changes to CT-PART affect this AREA only     GETHAN WINDOW >R GETHAN AREA >R 0                               DO I DO-ACTION      \ do action, skip next one?                  IF R> 1+ >R THEN   \ yes                                        STOP-SCAN? IF LEAVE THEN                                       LOOP                                                            R> SETHAN AREA R> SETHAN WINDOW R> TO CT-PART                  THEN ;                                                                                                                                                                                       ( AR-ACTION                                      < 6/28/89> 24)                                                                 : AR-ACTION \ vector so this can be disabled                       <AR-ACTION> ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ( 14:35) ( CUR/ALL? STARTTIME ELAPSED CALC-ELAPSED        <12/16/88> 25) FORTH                                                                                                                            0 CONSTANT CUR/ALL?    \ 1=Scan only current winbow/0=all         DVARIABLE STARTTIME  \ EVTCLK at start of screen                                                                             : CALC-ELAPSED \ calculate elapsed ticks since                     \ STARTTIME was set (for flashing things/timing)                @EVTCLK STARTTIME D@ D- DDUP 0 1 D< NOT                         IF DDROP ( -1 ) 0 ELSE DROP THEN TO ELAPSED ;                                                                                                                                                                                                                                                                                                                                                                                                                ( WN-ACTION                                      < 1/24/89> 26) FORTH                                                                                                                           : WN-ACTION \ scan all areas in WINDOW for something to do         GETHAN AREA >R                                                  @@ WN-AREAS                                                     BEGIN DUP                                                       WHILE SETHAN AREA AR-ACTION                                      STOP-SCAN?                                                      IF 0 ELSE @@ AR-NEXT THEN                                      REPEAT DROP                                                     0 INIT !! WN-FLAG ( init has now been done )                    R> SETHAN AREA                                               ;                                                                                                                                                                                               ( SCAN-EMPTY ADD-SCAN                            < 5/ 8/89> 27)                                                                 0 CONSTANT #SCAN  \ # windows in SCAN-WINS                                                                                      CREATE SCAN-LIST ( segment of windows to scan in ACTIONS )         40 ALLOT                                                                                                                     : ^SCAN# ( n -- adr, point to table, N=1 is first )                DUP 1 #SCAN WITHIN NOT ABORT" ^SCAN#: rng err"                  1- 2* SCAN-LIST + ;                                                                                                          : @SCAN# ( n -- seg, return seg of window n, 1=first )             ^SCAN# @ ;                                                                                                                                                                                                                                                   ( SCAN-EMPTY ADD-SCAN                            < 5/ 8/89> 28)                                                                 : SCAN-EMPTY ( --, empty actions scan buffer )                     0 TO #SCAN                                                      1 TO STOP-SCAN? ( stop scanning, we have new windows )       ;                                                                                                                               : ADD-SCAN ( seg -- add window to scan list )                      1 TO STOP-SCAN? ( stop if windows added )                       #SCAN 20 U< NOT ABORT" ADD-SCAN: overflow!"                     #SCAN 1+ DUP TO #SCAN ^SCAN# ! ;                                                                                                                                                                                                                                                                                                                                                             ( <ACTIONS>                                      < 6/27/89> 29) FORTH                                                                                                                           : <ACTIONS> \ -- execute all current actions                       GETHAN WINDOW >R \ default condition                            #SCAN ?DUP                                                      IF 0                                                             DO I 1+ @SCAN# SETHAN WINDOW WN-ACTION                           STOP-SCAN? IF LEAVE THEN                                       LOOP                                                           THEN                                                            R> SETHAN WINDOW ;                                                                                                                                                                                                                                                                                                           ( ACTIONS                                        < 6/28/89> 30)                                                                 : ACTIONS \ scan all windows for anything to do                    CALC-ELAPSED            \ set ELAPSED ticks                     CT-PART >R 0 TO CT-PART \ temp clear part value                 CUR/ALL?                \ scan only the current window?         IF WN-ACTION            \ only look at the current window       ELSE <ACTIONS> THEN                                             R> TO CT-PART                                                   0 TO 1ST-PASS?          \ clear flag                         ;                                                                                                                                                                                                                                                                                                                                                                                      ( 10:40) ( GET-TRACK-EVENT                                <11/29/88> 31) FORTH                                                                                                                           : GET-TRACK-EVENT ( n --, n is exit event )                        \ execute ACTIONS while waiting                                 >R @EVT-XY                                                      BEGIN GET-EVENT @EVTNUM R@ = NOT GNME-FLAG 0= AND               WHILE MOUSE-EVENT?                                               IF DDUP @EVT-XY D= NOT ELSE 0 THEN                              \ if we are going to loop again check actions                   DUP 0= KEY-EVENT? NOT AND                                       IF ACTIONS THEN                                                REPEAT-UNTIL                                                    DDROP R> DROP 0 TO GNME-FLAG ;                                                                                                                                                               ( DO-TRACK                                       <11/23/88> 32) -CTRUN-                                                           \ CT-FUNC: 0=1st in 1=2nd in 2=move 3=out 4=cleanup                                                                           : DO-TRACK \ --, track mouse for CT-TRACK                          \ CT-PART holds original part number                            CT-PART >R CT-FIND                                              CT-PART R@ = TO CT-VALID    \ set valid flag                    R> TO CT-PART                                                   CT-VALID CT-FUNC 1 > XOR    \ moved in/out of original part?    IF CT-DO-FUNC THEN          \ turn on/off                       CT-VALID IF 3 ELSE 1 THEN   \ set next function number          TO CT-FUNC                                                   ;                                                                                                                                                                                               ( CT-TRACK                                       <11/23/88> 33) -CTRUN-                                                           \ CT-FUNC: 0=1st in 1=2nd in 2=move 3=out 4=cleanup             \ function 2 not used by CT-TRACK                                                                                             : CT-TRACK \ -- t/f, track mouse t=release in part                 @EVTNUM 1+ >R                  \ exit event number              0 TO CT-FUNC 1 TO CT-VALID       \ set first func number        BEGIN DO-TRACK @EVTNUM R@ = NOT                                 WHILE R@ GET-TRACK-EVENT REPEAT                                 CT-VALID DUP                     \ still inside control?        IF 3 CT-DO-FUNC# ELSE 0 TO CT-PART THEN \ turn it off           4 CT-DO-FUNC# R> DROP ;          \ cleanup                                                                                                                                                                                                                   ( CT-DIAL                                        <11/23/88> 34) -CTRUN-                                                           \ CT-FUNC: 0=1st in 1=2nd in 2=move 3=out 4=cleanup                                                                           : DO-DIAL \ -- handle mouse info for dial                          CT-FIND-DIAL CT-VALID     \ still inside dial?                  IF CT-DO-FUNC             \ yes, init or move                    2 TO CT-FUNC             \ next func is move                   ELSE CT-FUNC 2 =          \ no, were we moving?                  IF 3 CT-DO-FUNC# THEN    \ yes, move out                        1 TO CT-FUNC             \ next func is reenter                THEN                                                         ;                                                                                                                                                                                                                                                               ( CT-DIAL                                        <11/23/88> 35) -CTRUN-                                                           \ CT-FUNC: 0=1st in 1=2nd in 2=move 3=out 4=cleanup                                                                           : CT-DIAL \ -- t/f, track dial t=release in part                   @EVTNUM 1+ >R            \ exit event                           0 CT-DO-FUNC#              \ run init function                  2 TO CT-FUNC 1 TO CT-VALID \ next functon is move               BEGIN DO-DIAL @EVTNUM R@ = NOT                                  WHILE R@ GET-TRACK-EVENT                                        REPEAT                                                          CT-VALID DUP               \ still in part?                     IF 3 CT-DO-FUNC# ELSE 0 TO CT-PART THEN                         4 CT-DO-FUNC# R> DROP ;    \ cleanup                                                                                                                                                         ( CT-WATCH                                       <12/ 8/88> 36) ROOT -CTRUN- FORTH                                              : CT-WATCH \ -- t/f, was mouse movement in current control/part    \ return T if item was selected, F if not selected              \ assumes AREA points to control and EVENT contains             \ the initial press event in AREA returns on EVTNUM + 1         1 TO TRACKING?                                                  @@ AR-TYPE 14 = \ special control exits immed                   IF 1 TO CT-PART 1 TO CT-VALID 1                                 ELSE CT-FIND CT-PART DUP                                         IF 128 < \ is it a normal part or a dial?                        IF CT-TRACK ELSE CT-DIAL THEN                                  THEN                                                           THEN 0 TO TRACKING? ;                                                                                                                                                                        ( ?TAREA                                         <12/ 1/88> 37) ROOT FORTH -CTRUN-                                                                                                              : ?TAREA ( --, handle displaying text area )                       @@ AR-TYPE 10 = \ editable text?                                IF @@ WN-TED 0= ( none set? )                                    IF WN-ATTRIB-SET ( use default set )                             AR-NUM !! WN-TED AR-TITLE C@L 1+                                !! AR-MIN 1 !! AR-VAL CT-DRAW-VAL                              ELSE @@ WN-TED AR-NUM = IF CT-DRAW-VAL THEN                     THEN                                                           THEN ;                                                                                                                                                                                                                                                                                                                       ( WF1 WF2                                        <12/ 2/88> 38) -CTRUN-                                                                                                                         : WF1 ( --, single border inside window )                          ERASE WN-FILL                                                   DRAW @@ WN-XPOS 1+ @@ WN-YPOS 1+                                @@ WN-XPOS @@ WN-WID + 2-                                       @@ WN-YPOS @@ WN-HT + 2- 1 FRAME ;                                                                                           : WF2 ( --, erase window )                                         ERASE WN-FILL ;                                                                                                                                                                                                                                                                                                                                                                              ( WF3 WF4 WF5                                    < 3/20/89> 39)                                                                 : WF3 ( double wide frame )                                        ERASE WN-FILL                                                   DRAW                                                            @@ WN-XPOS 3 + @@ WN-YPOS 3 +                                   @@ WN-XPOS @@ WN-WID + 5 -                                      @@ WN-YPOS @@ WN-HT + 5 - 2 FRAME ;                                                                                          : WF4 ( preserve whats on the screen )                             0 DISP-HT SAVE-SCR ;                                                                                                         : WF5 ( preserve buffer, nothing to do )                           NOOP ;                                                                                                                                                                                       ( DRAW-WN-FRAME                                  <12/ 2/88> 40) -CTRUN-                                                                                                                         CASE: <DRAW-WN-FRAME>                                             NOOP WF1 WF2 WF3 WF4 WF5 ;                                                                                                    : DRAW-WN-FRAME                                                    HIDE-MOUSE                                                      @@ WN-FRAME 1 5 WITHIN                                          IF @@ WN-FRAME <DRAW-WN-FRAME> THEN                             SHOW-MOUSE                                                   ;                                                                                                                                                                                                                                                                                                                               ( DISP-INIT                                      <12/ 2/88> 41) ROOT -CTRUN- FORTH                                                                                                              : DISP-INIT ( -- called when drawing window  )                     CALC-WID @@ AR-FLAG \ compute area width?                       IF @@ WN-WID @@ AR-XPOS @@ WN-XPOS - 2* - !! AR-WID THEN     ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               ( CT-REDISP                                      < 4/22/89> 42) FORTH                                                           : ?ONTIME ( --, clear visible if it has ontime )                   INIT @@ WN-FLAG @@ AR-ON 0> AND ( has on time )                 IF CT-DISAB  ( turn it off now )                                THEN ;                                                                                                                       : <CT-REDISP> \ -- , redraw a control                              DRAW-WIN?                                                       IF DISP-INIT THEN \ resize controls if drawing and bits set     AR-ACTION \ allow controls to change before we draw             VISIBLE @@ AR-FLAG                                              IF @@ WN-TFONT TX-FONT CT-DRAW ?TAREA THEN                   ;                                                                                                                                                                                               ( CT-RESISP                                      < 6/17/89> 43)                                                                 : <CT-REDISP-INIT>                                                 0 TO CT-PART 0 TO ELAPSED 1 TO DRAW-WIN? ;                                                                                   : CT-REDISP \ redraw window/controls without initing fields        <CT-REDISP-INIT>                                                DRAW-WN-FRAME                                                   @@ WN-AREAS                                                     BEGIN ?DUP                                                      WHILE SETHAN AREA ?ONTIME <CT-REDISP> @@ AR-NEXT                REPEAT                                                          0 TO DRAW-WIN? ;                                                                                                                                                                                                                                             ( CT-DISP                                        <12/ 2/88> 44) FORTH                                                                                                                           : CT-DISP \ draw controls, point to first text field               0 !! WN-TED       \ recompute first text edit field             1 INIT !! WN-FLAG                                               CT-REDISP                                                       0 INIT !! WN-FLAG \ clear init flag                          ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               ( DEFALLOC                                       <11/28/88> 45) ROOT -CTRUN- FORTH                                                                                                              : DEFALLOC ( pfa -- )                                              >R \ 0=num 2=flag 4=type 6=h 8=w 10=y 12=x 14=str               AR-ALLOC 0= ABORT" DEFALLOC: mem err"                           R@ @ AR-NUM-CA           \ reserve space for list               R@ 14 + COUNT CT-TITLE   \ set title                            @@ WN-XPOS R@ 12 + @ +   \ x pos                                @@ WN-YPOS R@ 10 + @ +   \ y pos                                R@ 8 + @ R@ 6 + @ AR-LOC \ width ht                             R@ 4 + @ !! AR-TYPE      \ control type                         R> 2+ @ ^^ AR-FLAG C!L   \ set flag to value                 ;                                                                                                                                                                                               ( DO-WN-RUN                                      < 1/24/89> 46) ROOT FORTH -CTRUN-                                                                                                              : DO-WN-RUN ( --, exits on left-up )                              GET-EVENT KEY-EVENT? NULL-EVENT? OR                             IF ACTIONS ( only look in my window for actions )               ELSE MOUSE-EVENT? L-DOWN-EVENT? AND                              IF FIND-AREA                                                     IF GETHAN WINDOW >R CT-WATCH                                     IF AR-ACTION THEN                                               R> SETHAN WINDOW                                               THEN                                                           ELSE @EVT-XY IN-WINDOW? NOT IF 3333 1 TONE THEN                 THEN                                                           THEN ;                                                                                                                        ( WR-INIT                                        < 3/ 3/89> 47) ROOT FORTH                                                      0 CONSTANT EXIT-WN-RUN?                                         -CTRUN-                                                                                                                         : WR-INIT \ --, WN-RUN inits                                      1 TO CUR/ALL?       \ only scan the current window              0 TO EXIT-WN-RUN?   \ clear flag                                1 KEYENAB !! WN-FLAG   1 ENABLE !! WN-FLAG                      1 INIT !! WN-FLAG      1 VISIBLE !! WN-FLAG                   \ 1 SCANWIN !! WN-FLAG                                            CT-DISP             \ draw the window                         ;                                                                                                                                                                                                                                                               ( START-WN-RUN                                   < 3/30/89> 48) -CTRUN-                                                         VARIABLE OLD-WRFLAGS                                                                                                            ROOT -CTRUN- FORTH                                                                                                              : START-WN-RUN ( -- draw window  and init for FINISH )             HIDE-MOUSE POINTER                                              WN-SAVE-UNDER !! WN-DATA \ save under window                    SHOW-MOUSE                                                      WR-INIT ;                                                                                                                                                                                                                                                                                                                                                                                    ( FINISH-WN-RUN WN-RUN                           < 3/30/89> 49) FORTH                                                                                                                           : FINISH-WN-RUN ( -- , run window, put it away )                   ( run WINDOW until EXIT-WN-RUN? set to true )                   BEGIN POINTER DO-WN-RUN EXIT-WN-RUN? UNTIL                      0 TO CUR/ALL?            \ restore to default                   0 ^^ WN-FLAG C!L         \ restore original flags               HIDE-MOUSE                                                      @@ WN-DATA WN-RESTORE 0 !! WN-DATA                              SHOW-MOUSE ;                                                 : WN-RUN                                                           DEC-DEATH-COUNT \ of resources                                  START-WN-RUN                                                    FINISH-WN-RUN ;                                                                                                              ( ?PART: ?CONDKEY ?ALT:                          <11/28/88> 50) FORTH                                                           : ?PART: \ create arg is part number                               CREATE C,                                                       DOES> C@ CT-PART = ;                                                                                                         : ?CONDKEY ( -- T/F, T=should we check for keys )                  KEYENAB @@ AR-FLAG                                              KEYENAB @@ WN-FLAG AND ;                                                                                                     : ?ALT: \ create arg is ascii value                                CREATE C,  ( case is ignored becuase of ?KEYCODE)               DOES> C@ ?KEYCODE ALT? AND ?CONDKEY AND ;                                                                                                                                                                                                                    ( ?FKEY: ?KEY:                                   < 1/25/89> 51) FORTH                                                           : ?FKEY: \ create arg is function key number                       CREATE C,                                                       DOES> C@ ?oa@?CONDKEY AND                                      SHIFT? NOT AND CTRL? NOT AND ALT? NOT AND ;                                                                                 : ?KEY: \ create arg is ascii value to check                       CREATE C,                                                       DOES> C@ ?KEYCODE ?CONDKEY AND ;                                                                                             : ?SCAN: \ create arg is scancode to check                         CREATE C,                                                       DOES> C@ ?SCANCODE ?CONDKEY AND ;                                                                                                                                                            ( PART1? PART2? PART3? PART4? PART128?           < 1/25/89> 52) FORTH                                                                1 ?PART: PART1?                                                 2 ?PART: PART2?                                                 3 ?PART: PART3?                                                 4 ?PART: PART4?                                               128 ?PART: PART128?                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ( ALTQ? CR? ESC? F1? - F10?                      < 1/25/89> 53) FORTH                                                              ASCII Q  ?ALT: ALTQ?                                                 13  ?KEY: CR?                                                   27  ?KEY: ESC?                                                   1 ?FKEY: F1?                                                    2 ?FKEY: F2?                                                    3 ?FKEY: F3?                                                    4 ?FKEY: F4?                                                    5 ?FKEY: F5?                                                    6 ?FKEY: F6?                                                    7 ?FKEY: F7?                                                    8 ?FKEY: F8?                                                    9 ?FKEY: F9?                                                   10 ?FKEY: F10?                                                                                                 ( 11:16)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ( LAST SCREEN                                    < 8/14/89> 55)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 