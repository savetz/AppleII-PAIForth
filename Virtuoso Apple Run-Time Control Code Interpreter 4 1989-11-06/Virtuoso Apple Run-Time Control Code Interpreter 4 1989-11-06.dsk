                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ( LOADBLOCK                                      <11/ 9/89>141) L64 ONLY FORTH ALSO DEFINITIONS                                 CR CR ." First word: -CEMITS- (ASTART)" CR CR                                                                                   XCREATE ASTART                                                     150 214 THRU  \ control code interpreter                        220 269 THRU  \ Character size words                                                                                         \ FORGET ASTART                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ( fah  )                                                                                                                                 ONLY FORTH ALSO DEFINITIONS                                                                                                     FORGET -CEMITS-                                                 FORGET ASTART                                                                                                                                                                                                                                                   141 LOAD                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ( Control code interpreter notes                 <11/ 6/89>150) EXIT --------------------------------------------------------                                                                   This code is functionaly identical to IBM except the following  used functionality has been removed:                                                                                              -- Italics, Teletype (might install later)                      -- Bullets (markers)                                            -- Wait and View page                                           -- Underline color holds color number not color mask            -- DPARAMS table accessed directly                                                                                                                                                                                                                                                                                                                                                            ( Control code interpreter notes                 <11/ 7/89>151) EXIT --------------------------------------------------------                                                                   Most parameters in DPARAMS have been implemented as bytes       in the apple version (basically all but x cordinates)                                                                           the zero page variable zptr is used by subroutines for scratch  stoarge and not expected to hold values between calls                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ( fah  ) ( -CEMITS-                                       <11/ 6/89>152)                                                                 ONLY FORTH ALSO DEFINITIONS                                                                                                       VOCABULARY -CEMITS- IMMEDIATE                                                                                                 ONLY FORTH ALSO -CEMITS- ALSO FORTH DEFINITIONS                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ( fah  ) ( VARIABLES                                      <11/ 6/89>153) FORTH DEFINITIONS                                                                                                               0 CONSTANT INDENT      \ GX val where indent is set               CREATE TMARKS        \ X , Y , seg , ofs ,                        16 8 * ALLOT       \ for marks 0 to #TMARKS-1               0 CONSTANT EMSEG       \ segment val saved to TMARKS            0 CONSTANT EMOFS       \ offset val saved to TMARKS                                                                             EXIT ----------------------------------------                   0 CONSTANT DO-EFFECTS? \ if true, do conditional effects        0 CONSTANT STOPWAIT?   \ set to true to stop delays               DVARIABLE DWTC       \ time counter used by wait words        : WHOOK NOOP ;        \ hook timer interupt word here                                                                                                                                  ( fah  ) ( PARAMETER TABLE                                <11/ 6/89>154) EXIT -- DEFINED IN CDRAW2.STP --                                CREATE DPARAMS \ current draw parameters                          2 ALLOT \  0: Current character                                 4 ALLOT \  2: character set pointer                             2 ALLOT \  6: font number                                       2 ALLOT \  8: old font number                                   2 ALLOT \ 10: font offset                                       2 ALLOT \ 12: num extra pixs to add to width *                  2 ALLOT \ 14: num extra pixs to add to height *                 2 ALLOT \ 16: italics increment                                 2 ALLOT \ 18: italics offset                                    2 ALLOT \ 20: height of a blank line                            2 ALLOT \ 22: fixed line ht                                                                                                   \ * see note next screen                               ( fah  ) ( PARAMETER TABLE cont                           <11/ 6/89>155) EXIT -- DEFINED IN CDRAW2.STP --                                                                                                  2 ALLOT \ 24: kerning                                           2 ALLOT \ 26: leading                                           2 ALLOT \ 28: underline offset                                  2 ALLOT \ 30: last control code                                 2 ALLOT \ 32: space to add before next character                                                                                \ more table on next screen                                   EXIT                                                              * Values marked are used by CSIZE and are not need by the         draw code as the process of drawing gives us this info.         However, this code sets these values so that CS-INIT            simply copies the table to obtain the current modes                                                                ( fah  ) ( PARAMETER TABLE cont                           <11/ 6/89>156) EXIT -- DEFINED IN CDRAW2.STP --                                                                                                \ extra parameters required by draw not needed by CSIZE           2 ALLOT \ 34: Last underline x position (-1 disables)           2 ALLOT \ 36: Last underline y position (of line)               2 ALLOT \ 38: Current color mask for underline                  2 ALLOT \ 40: Previous color                                    2 ALLOT \ 42: Color mask for first color                        2 ALLOT \ 44: Color mask for second color                       2 ALLOT \ 46: If set drawing in teletype mode                   2 ALLOT \ 48: draw mode (0=norm 1=bold 2=shadow)                                                                              10 ALLOT ( safety )                                                                                                                                                                    ( fah  ) ( CEMITS local variables                         <11/ 6/89>157) FORTH DEFINITIONS                                                                                                               VARIABLE DMODE       \ draw mode (0=left 1=centered 2=right)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ( fah  ) ( DO-NO DO-CTRL L                                <11/ 6/89>158) -CEMITS- DEFINITIONS                                            SUBR DR \ dummy routine, a simple return                           RTS, S;                                                                                                                      XCREATE DO-MODE \ routines to print character in proper mode       DR , DR , DR ,                                                                                                               XCREATE DO-NO \ routines to run control with no args (1-6)         DR , DR , DR , DR , DR , DR ,                                                                                                XCREATE DO-CTRL \ routines to run ctrl codes with args (14-31)     DR , DR , DR , DR , DR , DR , DR ,                              DR , DR , DR , DR , DR , DR , DR ,                              DR , DR , DR , DR , DR , DR , DR ,                                                                                  ( fah  ) ( {font#}                                        <11/ 6/89>159) -CEMITS- DEFINITIONS                                                                                                            SUBR {font#} \ switch to font .A                                  DPARAMS 6 + ,X STA,           \ FONT# = A                       .A ASL, TAY,                  \ Y=font# * 2                     FONT-TABLE ,Y LDA,            \ lobyte of font offset           DPARAMS 2 + STA,                                                INY, FONT-TABLE ,Y LDA,       \ hibyte of font offset           DPARAMS 3 + STA,                                                ' FONT:SEG LDA,               \ lobyte of font segment          DPARAMS 4 + STA,                                                ' FONT:SEG 1+ LDA,            \ hibyte of font segemtn          DPARAMS 5 + STA,                                                RTS, S;                                                                                                              ( fah  ) ( {tfsave}                                       <11/ 6/89>160) -CEMITS- DEFINITIONS                                                                                                            SUBR {tfsave} \ save font#, color, cause italics to recompute      DPARAMS 6 + LDA,                  \ OLDFONT# = FONT#            DPARAMS 8 + STA,                                                TCLR LDA, DPARAMS 40 + STA,       \ OLDCOLOR = CFG              # 0 LDA, DPARAMS 18 + STA,        \ I-OFS = 0 (recompute)       RTS, S;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( fah  ) ( {iuofs}                                        <11/ 6/89>161) -CEMITS- DEFINITIONS                                                                                                            SUBR {iuofs} \ set A.= amount to shift underline if in italics    DPARAMS 18 + LDA, # 0 CMP, 0= NOT  \ if in italics              IF,                                                               DPARAMS 29 + LDY,                \ uofs hibyte                  DPARAMS 28 + LDA,                \ uofs lobyte                  DPARAMS 16 + LDX,                \ I-INC                        ' b/mod JSR,                     \ YA/X=&QUO &REM               &QUO LDA, CLC,                                                  DPARAMS 18 + ADC,                \ .A += I-OFS                THEN,                                                           RTS, S;                                                                                                                                                                              ( fah  ) ( {uline}                                        <11/ 6/89>162) -CEMITS- DEFINITIONS                                                                                                            \ *** uses zptr to access font table ***                                                                                        SUBR {uline} \ .A=y position for underline                         DPARAMS 2+ LDA, zptr STA,       \ move font ptr to zero page    DPARAMS 3 + LDA, zptr 1+ STA,                                   # 8 LDY, zptr )Y LDA,           \ .A = basel for cur font       CLC, DPARAMS 28 + ADC,          \ .A += UOFS                    CLC, GY ADC,                    \ .A += GY                      RTS, S;                                                                                                                                                                                                                                                                                                             ( fah  ) ( {ttnoise}                                      <11/ 6/89>163) -CEMITS- DEFINITIONS                                                                                                            SUBR {ttnoise} \  do teletype noise                              RTS, S; EXIT                                                                                                                     AL, # 182 MOV 67 , AL OUT NOP NOP                               AL, # 209 MOV 66 , AL OUT NOP NOP                               AL, #  11 MOV 66 , AL OUT NOP NOP                               AL, 97 IN AX PUSH AL, # 3 OR 97 , AL OUT                        CX, # 2000 MOV                                                  DO NOP NOP NOP NOP NOP LOOP                                     AX POP 97 , AL OUT                                              RET C;                                                                                                                                                                                        ( hcolor                                         <11/ 8/89>164) FORTH DEFINITIONS                                                                                                               LABEL hcolor \ set to print in color .A  X & Y destroyed          COLOR# STA,                                                     .A ASL, .A ASL, .A ASL,  \ *8                                   CLC, COLOR# ADC, TAX,    \ X = color# * 9                       0 # LDY,                 \ index into template                  BEGIN, COLORTAB ,X LDA, TEMPLATE ,Y STA,                          INY, INX, # 9 CPY, 0=                                         UNTIL,                                                          RTS, C;                                                                                                                                                                                                                                                                                                              ( fah  )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ( 0: Draw mode 0 - draw character                <11/ 6/89>166) -CEMITS- DEFINITIONS                                                                                                            SUBR drawmodes \ DPARAMS C@ = char to draw,                       HERE DO-MODE !   \ set jump table                               DPARAMS LDA,                                                    gemit JMP,                                                                                                                    ?CSP \ catch errors when they happen                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ( 1: draw mode 1 - bold                          <11/ 6/89>167)                                                                 \ print in 1st color, over 1 print again in 2nd color           HERE DO-MODE 2+ ! \ set jump table                                TCLR LDA, PHA,                    \ save current color          DPARAMS 42 + LDA, TCLR STA,       \ set 1st color               DPARAMS LDA, <gemit> JSR,         \ draw char w/o inc pos       DPARAMS 44 + LDA, TCLR STA,       \ set second color            GX INC, 0=                        \ inc x position              IF, GX 1+ INC, THEN,                                            DPARAMS LDA, gemit JSR,           \ draw character again        PLA, TCLR STA,                    \ restore color               RTS,                                                          ?CSP \ catch errors when they happen                                                                                                                                                   ( fah  ) ( 2: draw mode 2 - shadow                        <11/ 6/89>168) \ down 1, print 1st color, over 1, print 2nd color              HERE DO-MODE 4 + !                                                TCLR LDA, PHA,                    \ save current color          DPARAMS 42 + LDA, TCLR STA,       \ set first color             GY INC, 0= IF, GY 1+ INC, THEN,   \ decrment GY                 DPARAMS LDA, <gemit> JSR,         \ draw char w/o inc pos       DPARAMS 44 + LDA, TCLR STA,       \ set second color            GX INC, 0= IF, GX 1+ INC, THEN,   \ inc x position              GY LDA, 0= IF, GY 1+ DEC, THEN,   \ dec GY                      GY DEC, DPARAMS LDA, gemit JSR,                                 PLA, TCLR STA,                    \ restore color               RTS,                                                            ?CSP \ catch errors when they happen                          S;                                                                                                                              ( TROUTINES:  1 - Restore defaults               <11/ 6/89>169) -CEMITS- DEFINITIONS                                            SUBR TROUTINES \ reset defaults                                   HERE DO-NO ! \ set jump table                                   # 255 LDA, DPARAMS 34 + STA,         \ disable underline        # 0 LDA,                             \ UOFFS=0                  DPARAMS 12 + STA,                    \ WEXTRA=0                 DPARAMS 14 + STA,                    \ HEXTRA=0                 DPARAMS 16 + STA,                    \ I-INC=0                  DPARAMS 18 + STA,                    \ I-OFS=0                  DPARAMS 48 + STA,                    \ draw mode = 0              \ this falls through to the next piece of code                  \ which completes the initialization process                  ?CSP \ catch errors when they happen                                                                                                                                                 ( fah  ) (  2: Restore default font                       <11/ 6/89>170)                                                                 HERE DO-NO 2+ ! \ restore last font/color preserve modes          \ restore previous font and color                               DPARAMS 40 + LDA, # 255 CMP, 0= NOT \ is there an old color?    IF, TCLR STA,                   \ restore old color              DPARAMS 8 + LDA, {font#} JSR,  \ restore old font#              # 255 LDA, DPARAMS 40 + STA,   \ clear flag                    THEN,                                                           \ undo any font shifts (GY-=FONT offset)                        SEC, GY LDA, DPARAMS 10 + SBC, GY STA,                          GY 1+ LDA, DPARAMS  11 + SBC, GY 1+ STA,                                                                                      \ more....                                                                                                                                                                             ( fah  ) (  2: Restore default font cont                  <11/ 6/89>171)                                                                    \ preserve x spacing if still in italics mode                \  BX, 16 [BP] MOV BX, BX OR       \ check I-INC                \  IF= not \ if not zero update twlast to maintain italics      \   AX, 10 [BP] MOV CWD BX IDIV    \ AX = FONTOFS / I-INC       \   AX, CS: GX ADD AX INC          \ AX = AX + GX + 1           \   CS: GX , AX MOV                \ shift character position   \  THEN                                                            \ clear font offset                                             # 0 LDA, DPARAMS 10 + STA,      \ FONTOFS = 0                                                                                   \ more...                                                                                                                                                                                                                                           ( fah  ) (  2: Restore default font cont                  <11/ 6/89>172)                                                                    \ end teletype mode                                          \  AX, 46 [BP] MOV AX, # 0 CMP     \ teletype mode on?          \  IF= not ' {doeff} CALL          \ check if we should do now  \   IF= AX DEC ' {sb-num} CALL     \ reset old screen buffer    \     ' {savescr} CALL             \ copy screen to buffer      \     AX, # 0 MOV 46 [BP], AX MOV  \ clear flag                 \   THEN                                                        \  THEN                                                            RTS,                                                                                                                         ?CSP \ catch errors when they happen                                                                                                                                                                                                                   ( fah  ) (  3: start teletype mode                        <11/ 6/89>173)                                                                 EXIT ------- NOT IMPELEMENTED -------------                     HERE DO-NO 4 + !                                                  ' {doeff} CALL     \ should we do teletype mode?                IF= \ AX, CS: ' SB# MOV                                       \   ' {sb-view} CALL        \ view current page                     AX INC 46 [BP], AX MOV  \ set teletype flag to scr num + 1      AX, CS: CRTSEG MOV                                              CS: ' DRAW:SEG , AX MOV \ draw to screen                      THEN                                                            RET                                                                                                                           ?CSP \ catch errors when they happen                                                                                                                                                   ( fah  ) (  4 & 5: Set temp margins at current position   <11/ 6/89>174)                                                                 HERE DO-NO 6 + ! \ set temp left margin                           GX  LDA, ' INDENT STA,       \ INDENT=GX                        GX 1+ LDA, ' INDENT 1+ STA,                                     RTS,                                                                                                                          ?CSP \ catch errors when they happen                                                                                                                                                            EXIT                                                              there is no action required for 5 as it is interpreted          by DTEXT.STP (ADDSIZE)                                                                                                                                                                                                                               ( fah  ) ( 14: switch to temp font m, n pixels above top  <11/ 6/89>175)                                                                 HERE DO-CTRL ! \ set jump table                                    {tfsave} JSR,                     \ save current font/color     DPARAMS LDA, .A LSR, .A LSR,      \ bits 3-5 are font#          .A LSR, # 7 AND, {font#} JSR,     \ set new font                DPARAMS LDA, # 7 AND,             \ bits 0-2 are amount above   zptr STA, SEC, # 0 LDA,           \ no negate on 6502           zptr SBC, DPARAMS 10 + STA,       \ FONTOFS=0-n                 CLC, GY ADC, GY STA,              \ GY += FONTOFS  (0-n)        RTS,                                                                                                                         ?CSP \ catch errors when they happen                                                                                                                                                                                                                   ( fah  ) ( 15: switch to temp font m, n pixels below bot  <11/ 6/89>176)                                                                 HERE DO-CTRL 2+ ! \ set jump table                                 {tfsave} JSR,                                                   DPARAMS 2+ LDA, zptr STA,         \ move font ptr to zpage      DPARAMS 3 + LDA, zptr 1+ STA,                                   # 8 LDY, zptr ,Y LDA, PHA,        \ save old basel              DPARAMS LDA, .A LSR, .A LSR,      \ bits 3-5 are font#          .A LSR, # 7 AND, {font#} JSR,     \ set new font                                                                             \ more...                                                                                                                                                                                                                                                                                                                                                                                       ( 15: cont                                       <11/ 6/89>177)                                                                    DPARAMS LDA, # 7 AND, zptr STA, \ bits 0-2 are amount below     PLA, CLC, zptr ADC,             \ zptr.A = n + oldbasel         DPARAMS 2+ LDY, zptr STY,       \ move font ptr to zpage        DPARAMS 3 + LDY, zptr 1+ STY,                                   # 8 LDY, SEC, zptr )Y SBC,      \ .A = .A - newbasel            DPARAMS 10 + STA,               \ FONTOFS = .A                  CLC, GY ADC, GY STA,            \ GY += FONTOFS                 RTS,                              \ done                                                                                     ?CSP \ catch errors when they happen                                                                                                                                                                                                                                                                                   ( fah  ) ( 16: Set default font to n                      <11/ 6/89>178)                                                                 HERE DO-CTRL 4 + !                                                 DPARAMS LDA, # 15 AND,         \ bits 0-3 are font num          {font#} JSR,                                                    # 0 LDA, DPARAMS 10 + STA,     \ FONTOFS = 0                    DPARAMS 18 + STA,              \ I-OFFS = 0 ( recompute )       RTS,                                                                                                                         ?CSP \ done, return and check                                                                                                                                                                                                                                                                                                                                                                                                                          ( fah  ) ( 17: Set text color                             <11/ 6/89>179)                                                                 HERE DO-CTRL 6 + !                                                 \ APPLE -- only two text colors supported 0=black 1=white       DPARAMS LDA, # 1 AND,        \ bits 0-3 are text color          TCLR STA,                    \ set color                        RTS,                                                         ?CSP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ( fah  ) ( 18: Set kerning to n                           <11/ 6/89>180)                                                                 HERE DO-CTRL 8 + !                                                 DPARAMS LDA, # 15 AND,            \ bits 0-3 are kerning        DPARAMS 24 + STA,                 \ CDX = 0                     RTS, ?CSP                         \ done, return and check                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ( 19: Strart underlining n pixs below baseline   <11/ 6/89>181)                                                                 HERE DO-CTRL 10 + !                                                DPARAMS LDA, .A LSR, .A LSR,      \ bits 3-5 are color #        .A LSR, # 7 AND, DPARAMS 38 + STA, \ save undln color #         DPARAMS LDA, # 7 AND,             \ bits 0-2 pixs below base    DPARAMS 28 + STA,                 \ UOFS = n                    {iuofs} JSR, zptr STA,            \ .A=underline offseT         GX LDA, SEC, zptr SBC,            \ UXLAST = GX-IUOFS           DPARAMS 34 + STA,                                               GX 1+ LDA, # 0 SBC, DPARAMS 35 + STA,                           {uline} JSR, DPARAMS 36 + STA,    \ UYLAST = here               RTS, ?CSP                                                                                                                                                                                                                                                    ( 20: Start bold printing                        <11/ 6/89>182)                                                                 HERE DO-CTRL 12 + !                                                DPARAMS LDA, .A LSR, .A LSR,      \ bits 3-5 are 1st color      .A LSR, # 7 AND, DPARAMS 42 + STA, \ set 1st color              DPARAMS LDA, # 7 AND,             \ bits 0-2 are 2nd color      DPARAMS 44 + STA,                 \ set 2nd color               # 1 LDA, DPARAMS 12 + STA,        \ TWEXTRA=1                   DPARAMS 48 + STA,                 \ draw mode = 1               # 0 LDA, DPARAMS 14 + STA,        \ THEXTRA=0                   RTS, ?CSP                         \ done, return and                                                                                                                                                                                                                                                                                                                                ( fah  ) ( 21: Start shadow printing                      <11/ 6/89>183)                                                                 HERE DO-CTRL 14 + !                                                DPARAMS LDA, .A LSR, .A LSR,      \ bits 3-5 are 1st color      .A LSR, # 7 AND, DPARAMS 42 + STA, \ set 1st color              DPARAMS LDA, # 7 AND,             \ bits 0-2 are 2nd color      DPARAMS 44 + STA,                 \ set 2nd color               # 1 LDA, DPARAMS 12 + STA,        \ TWEXTRA=1                   # 2 LDA, DPARAMS 48 + STA,        \ draw mode = 2               # 0 LDA, DPARAMS 14 + STA,        \ THEXTRA=0                                                                                   RTS, ?CSP                         \ done, return and check                                                                                                                                                                                                                                                          ( fah  ) ( 22: Set leading                                <11/ 6/89>184)                                                                 HERE DO-CTRL 16 + !                                                DPARAMS LDA, # 15 AND,            \ bits 0-3 are leading        DPARAMS 26 + STA,                 \ CDY = 0                                                                                     RTS, ?CSP                         \ done, return and check                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ( fah  ) ( 23: Set italics                                <11/ 6/89>185)                                                                 EXIT ----------- NOT YET IMPLEMENTED ----------------           HERE DO-CTRL 18 + !                                                AX, [BP] MOV AX, # 3 AND         \ bits 0-1 are lean amount     16 [BP], AX MOV                  \ I-INC = n                    AX, # 0 MOV 18 [BP], AX MOV      \ I-OFS = 0                                                                                    RTS, ?CSP                        \ done, return and check                                                                                                                                                                                                                                                                                                                                                                                                                                                           ( fah  ) ( 24: Set fixed line height                      < 4/ 6/88> 45)                                                                 HERE DO-CTRL 20 + !                                                DPARAMS LDA, # 31 AND,            \ bits 0-5 are line height    DPARAMS 22 + STA,                 \ LINE-HT = n                                                                                 RTS, ?CSP                         \ done, return and check                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ( 25: Set blank line heigth                      <11/ 6/89>187)                                                                 HERE DO-CTRL 22 + !                                                DPARAMS LDA, # 31 AND,            \ bits 0-5 are line height    DPARAMS 20 + STA,                 \ BLANK-HT = n                                                                                RTS, ?CSP                         \ done, return and check                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ( fah  ) ( 26: set print mode                             < 4/ 6/88> 47)                                                                 HERE DO-CTRL 24 + !                                                DPARAMS LDA, # 3 AND,          \ bits 0-1 are print mode        DMODE STA,                     \ set justify mode            \  48 [BP], AX MOV                \ set print mode                                                                                 RTS, ?CSP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ( 27: view screen                                <11/ 6/89>189) EXIT -------- NOT IMPLEMENTED -------------                                                                                     HERE DO-CTRL 26 + !                                                ' {doeff} CALL                                                  IF= AX, [BP] MOV AX, # 31 AND \ wait n half seconds               ' {2dwait} CALL                                            \    AX, CS: ' SB# MOV           \ view screen buffer           \    ' {sb-view} CALL                                              THEN                                                            RTS, ?CSP                                                                                                                                                                                                                                                                                                                                                                           ( fah  ) ( 28: Display a marker                           <11/ 6/89>190) EXIT -------- NOT IMPLEMENTED -------------                                                                                     HERE DO-CTRL 28 + !                                                \ wait .5sec, view, wait n*.5 sec, draw marker, view            \ also sets INDENT to value                                     ' {doeff} CALL                                                  IF= AX, # 1 MOV ' {2dwait} CALL      \ delay after bullet    \    AX, CS: ' SB# MOV ' {sb-view} CALL \ view sceen                 AX, [BP] MOV AX, # 7 AND           \ bits 0-2 are wait          ' {2dwait} CALL                    \ wait                     THEN                                                                                                                         \ more                                                                                                                                                                                 ( fah  ) ( 28: Display a marker cont                      <11/ 6/89>191) EXIT -------- NOT IMPLEMENTED -------------                         \ now we get to draw the marker                                AX, [BP] MOV AX, 1 SHR AX, 1 SHR  \ bits 3-5 are 1st color      AX, 1 SHR ' {tomask} CALL AH, AL MOV                            CS: PATBUF , AX MOV               \ set color for marker        BX, 2 [BP] MOV DS, 4 [BP] MOV     \ ptr to start of font        BL, 8 [BX] MOV BH, # 0 MOV BX PUSH \ base line position         AX, BX MOV BL, # 3 MOV BL IMUL                                  BL, # 4 MOV BL IDIV AH, # 0 MOV    \ AX=baseline*3/4            CX, CS: GX MOV AX, CX ADD AX, CX XCHG                           ' {endpts} CALL                   \ AX=left CX=right            DI, CS: GY MOV CX POP CX PUSH     \ DI=start CX=count           DO ' {?hline} CALL DI INC LOOP   \ draw bar                  \ more...                                                                                                              ( fah  ) ( 28: Display a marker cont                      <11/ 6/89>192) EXIT -------- NOT IMPLEMENTED -------------                                                                                        BX POP BX, 1 SHL                  \ BX=basel*2                  BX, CS: GX ADD CS: GX , BX MOV    \ GX +=BX                     CS: ' INDENT , BX MOV             \ INDENT = GX                                                                              \ now view the wonderful marker we just drew                    \  ' {doeff} CALL                                               \  IF= AX, CS: ' SB# MOV                                        \    ' {sb-view} CALL                \ view sceen               \  THEN                                                                                                                            RTS, ?CSP                         \ done, return and check                                                                                                                          ( fah  ) ( 29: Print char without translation             <11/ 6/89>193)                                                                 EXIT                                                                                                                            HERE TDO-CTRL 30 + !                                                                                                              --- see note at the bottom of {addsize} ----                                                                                  Basically, {addsize} is called directly with the parameter      so it is added to the width without trying to interpret         it as a control code                                                                                                                                                                                                                                                                                                                                                                   ( fah  ) ( 30: Save cursor position                       <11/ 6/89>194)                                                                 HERE DO-CTRL 32 + !                                                DPARAMS LDA, # 15 AND,         \ bit 0-3 is var number          .A ASL, .A ASL, .A ASL, TAY,   \ *8                             GX         LDA, TMARKS ,Y STA, INY,  \ store x pos              GX 1+      LDA, TMARKS ,Y STA, INY,                             GY         LDA, TMARKS ,Y STA, INY,  \ y pos                    GY 1+      LDA, TMARKS ,Y STA, INY,                             ' EMSEG    LDA, TMARKS ,Y STA, INY,  \ message seg location     ' EMSEG 1+ LDA, TMARKS ,Y STA, INY,                             ' EMOFS    LDA, TMARKS ,Y STA, INY,  \ message ofs              ' EMSEG 1+ LDA, TMARKS ,Y STA,                                  RTS,                                                         S;                                                                                                                     ( fah  ) ( {dotele}                                       <11/ 6/89>195) -CEMITS- DEFINITIONS                                                                                                            SUBR {dotele}                                                       RTS, S;                                                     EXIT ------- NOT IMPLEMENTED ---------                            AX, 46 [BP] MOV AX, # 0 CMP      \ teletype on?                 IF= not ' {doeff} CALL           \ do effect?                    IF= ' {ttnoise} CALL            \ do teletype noise               AX, # 1 MOV ' {dwait} CALL    \ wait 1 tick from last         THEN                                                           THEN                                                            RET C;                                                                                                                                                                                                                                               ( fah  ) ( {dound}                                        <11/ 6/89>196) -CEMITS- DEFINITIONS                                            XVARIABLE undy \ line we want to draw this underline            XVARIABLE undx \ working var for calcing ending x                                                                               SUBR {dound} \ draw underline (if uxlast <> -1)                     DPARAMS 34 + LDA, # 255 CMP, 0=  \ underlining off?             IF, RTS, THEN,                  \ yes, return                   {uline} JSR, undy STA,          \ no, get pos of this line      DPARAMS 36 + CMP, 0=            \ is y pos the same?            IF, SEC, DPARAMS 34 + LDA,      \ is UXLAST U< GX                GX SBC, DPARAMS 35 + LDA,                                       GX 1+ SBC, CS NOT                                               IF, \ yes do the underline                                                                                                                                                                 ( {dound} cont                                   <11/ 6/89>197)      \ yes do the underline                                           DPARAMS 38 + LDA,              \ get underline color            # 31 AND, hcolor JSR,                                           DPARAMS 34 + LDA,              \ last x lobyte                  DPARAMS 35 + LDY,              \        hibyte                  setleft JSR,                   \ set left endpoint              SEC, GX LDA, DPARAMS 24 + SBC, zptr STA,                        GX 1+ LDA, DPARAMS 25 + SBC, zptr 1+ STA, \ zptr=CX-CDX         {iuofs} JSR, undx STA,         \ temp store                     SEC, zptr LDA, undx SBC, zptr STA,                              zptr 1+ LDA, # 0 SBC, TAY,                                      zptr LDA, SEC, # 1 SBC, CS IF, DEY, THEN,                       setright JSR,                  \ set right endpoint             undy LDX, ' $HLINE JSR,        \ draw the damn line                                                                       ( {dound} cont                                   <11/ 6/89>197)                                                                      THEN,                                                          THEN, \ done this, set to draw next                               \ ULASTX = GX-CDX-IUOFS  ULASTY = this Y                      SEC, GX LDA, DPARAMS 24 + SBC, zptr STA,                        GX 1+ LDA, DPARAMS 25 + SBC, zptr 1+ STA, \ zptr=CX-CDX         {iuofs} JSR, undx STA,             \ temp store                 SEC, zptr LDA, undx SBC,           \                            DPARAMS 34 + STA,                  \ ULASTX = zptr - IUOFS      zptr 1+ LDA, # 0 SBC,                                           DPARAMS 35 + STA,                                               RTS, S;                                                                                                                                                                                                                                                     ( {start-italics?}                               <11/ 6/89>199) -CEMITS- DEFINITIONS                                                                                                            SUBR {start-italics?} RTS, S;                                   EXIT ---------- NOT IMPLEMENTED -----------------                 AX, 16 [BP] MOV AX, AX OR            \ italics on?              IF= not AX, 18 [BP] MOV AX, AX OR    \ offset not set?           IF= DS PUSH                                                      BX, 2 [BP] MOV DS, 4 [BP] MOV   \ DS:BX points to set           AL, 8 [BX] MOV AH, AH XOR          \ AX = base line pos         CWD CX, 16 [BP] MOV CX IDIV        \ AX = AX / I-INC            18 [BP], AX MOV                    \ I-OFS = AX                 AX, CS: GX ADD CS: GX , AX MOV     \ GX += I-OFS                DS POP THEN                                                   THEN                                                            RET C;                                               ( fah  ) ( {do.char}                                      <11/ 7/89>201) -CEMITS- DEFINITIONS                                                                                                            SUBR {do.char} \ print char in AX through proper mode              DPARAMS 48 + LDA, .A ASL,  \ draw mode * 2                      CLC, # DO-MODE LOBYTE ADC,                                      HERE 11 + STA,             \ ** set indirect jump AHEAD!! **    # DO-MODE HIBYTE LDA, 0 # ADC,                                  HERE 5 + STA,              \ ** set indirect jump AHEAD!! **    108 C, 0 C, 1 C,           \ indirect jump                   S;                                                                                                                                                                                                                                                                                                                                                                                              ( {.char}                                        <11/ 7/89>202) -CEMITS- DEFINITIONS                                                                                                            SUBR {.char} \ char in DPARAMS C@                               \  {start-italics?} JSR,                                           {do.char} JSR,                                                  {dound} JSR,                                                 \  {dotele} JSR,                                                   RTS, S;                                                                                                                      S' {.char} DO-CTRL 30 + !                                       \ 29: Print char without translation simply calls {.char}       \ with its parameter so I just plant in table                                                                                                                                                                                                                   ( {mygemit}                                      <11/ 7/89>202) -CEMITS- DEFINITIONS                                                                                                            SUBR {mygemit} ( -- )                                              \ first check if this byte is a params to last control code     DPARAMS 30 + LDA, 0= NOT        \ last ctrl w/params?           IF, 0 # LDX, DPARAMS 30 + STX,  \ clear flag,                    SEC, # 14 SBC, .A ASL,         \ (last code - 14) * 2           CLC, # DO-CTRL LOBYTE ADC,     \ + DO-CTRL                      HERE 11 + STA,            \ ** set indirect jump AHEAD!! **     # DO-CTRL HIBYTE LDA, 0 # ADC,                                  HERE 5 + STA,             \ ** set indirect jump AHEAD!! **     108 C, 0 C, 1 C,          \ indirect jump                      THEN,                                                        EXIT MORE...                                                                                                                    ( {mygemit} cont                                 <11/ 7/89>203)                                                                    \ now check if this is a control with no parameters (1-6)       DPARAMS LDA, SEC, # 1 SBC, 0< NOT \ is char >= 1?               IF, # 6 CMP, 0<                   \ and less than 7?             IF, .A ASL,               \ yes run ctrl w/no params             CLC, # DO-NO LOBYTE ADC,                                        HERE 11 + STA,           \ ** set indirect jump AHEAD!! **      # DO-NO HIBYTE LDA, 0 # ADC,                                    HERE 5 + STA,            \ ** set indirect jump AHEAD!! **      108 C, 0 C, 1 C,         \ indirect jump                       THEN,                                                          THEN,                                                                                                                        EXIT MORE ....                                                                                                         ( fah  ) ( {mygemit} cont                                 <11/ 7/89>204)                                                                    \ now check if this is a control with paramers (14-31)          DPARAMS LDA, # 14 CMP, 0< NOT   \ is char >= 14?                IF, # 32 CMP, 0<                \ and less than 32?              IF, DPARAMS 30 + STA,          \ save char in TCTRL               RTS,                                                          THEN,                                                          THEN,                                                           \ if we get here we should just print the character             {.char} JMP, S;                                                                                                                                                                                                                                                                                                                                                                     ( fah  ) ( <MYGEMIT>                                      <11/ 7/89>205) -CEMITS- DEFINITIONS                                                                                                            CODE <MYGEMIT> ( C -- )                                           BOT LDA, DPARAMS STA,                                           XSAVE STX,                                                      {mygemit} JSR,                                                  XSAVE LDX,                                                      POP JMP, C;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ( fah  ) ( <GXYTAB>                                       <11/ 7/89>206) -CEMITS- DEFINITIONS                                                                                                            CODE <GXYTAB> ( x y -- )                                           BOT LDA, GY STA,                                                BOT 1+ LDA, GY 1+ STA,                                          SEC LDA, GX STA,                                                SEC 1+ LDA, GX 1+ STA,          \ set GX, GY                                                                                 \ MORE ...                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( <GXYTAB> cont                                  <11/ 7/89>207)                                                                    DPARAMS 34 + LDA, # 255 CMP, 0=  NOT \ italics off?             IF,                             \ no, set UXLAST , UYLAST        GX LDA, DPARAMS 34 + STA,      \ LASTUX = GX                    GX 1+ LDA, DPARAMS 35 + STA,                                    {uline} JSR, DPARAMS 36 + STA, \ LASTUY = underline pos        THEN,                                                           # 0 LDA, DPARAMS 18 + STA,      \ I-OFS = 0                     NEXT JMP, C;                                                                                                                                                                                                                                                                                                                                                                                                                                        ( fah  ) ( GXYTAB MYGEMIT                                 <11/ 7/89>208) FORTH DEFINITIONS                                                                                                               : GXYTAB ( x y -- )                                                <GXYTAB> ( UPDATE-TXY ) ;                                                                                                    : MYGEMIT ( C -- )                                                 <MYGEMIT> ( UPDATE-TXY ) ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ( EMITS-INIT                                     <11/ 7/89>209) FORTH DEFINITIONS                                               : +DP DPARAMS + ;                                               : EMITS-INIT                                                      0 10 +DP ! 0 30 +DP !               ( FONTOFS=0, LASTCTRL=0)    255 34 +DP ! 0 28 +DP !             ( underline off)            0 16 +DP ! 0 18 +DP !               ( italics off)              6 20 +DP ! 0 22 +DP !               ( BLHEIGHT=6, LHEIGHT=0)    1 24 +DP ! 1 26 +DP !               ( kerning/leading)          0 12 +DP ! 0 14 +DP ! 0 48 +DP !    ( normal draw mode)         0 32 +DP !                          ( clear var)                0 46 +DP !                          ( teletype mode off )       6 +DP @ 8 +DP !                     ( OLDFONT = CURFONT )       255 40 +DP !                        ( no old color )            REVECTOR MYGEMIT INTO GEMIT                                   ;                                                      ( fah  ) ( GTYPE                                          <11/ 8/89>210)                                                                 : GTYPE ( adr cnt -- )                                             ?DUP                                                            IF 0                                                             DO COUNT GEMIT LOOP                                            THEN                                                            DROP ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ( G."                                            <11/ 8/89>211) FORTH DEFINITIONS                                                                                                               : <G.">                                                            R> COUNT DDUP + >R GTYPE ;                                                                                                   : G."                                                              STATE @                                                         IF COMPILE <G.">                                                 34 WORD C@ 1+ ALLOT                                            ELSE 34 WORD COUNT GTYPE                                        THEN                                                         ; IMMEDIATE                                                                                                                                                                                                                                            ( fah  ) ( SWIDTH SHEIGTH SRISE PARAMS CS-INIT            <11/ 8/89>212) FORTH DEFINITIONS                                                                                                               0 CONSTANT SWIDTH                                               0 CONSTANT SHEIGHT                                              0 CONSTANT SRISE                                                                                                                CREATE PARAMS  \ parameter table used by CSIZE                     34 ALLOT                                                                                                                     : CS-INIT                                                          0 TO SWIDTH 0 TO SRISE DPARAMS 20 + @ TO SHEIGHT                DPARAMS PARAMS 32 CMOVE                                         0 PARAMS 12 + ! 0 PARAMS 14 + !                                 0 PARAMS 30 + ! 0 PARAMS 32 + ! ;                                                                                   ( fah  ) ( TX-MODE                                        <11/ 7/89>212) FORTH DEFINITIONS                                                                                                               : TX-MODE ( n -- )                                                DUP !! WN-TMODE DMODE ! ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ( TEST CODE                                      <11/ 8/89>214) EXIT ----------------------------------------------------       : ECHO                                                             BEGIN KEY DUP 27 -                                              WHILE DUP 13 =                                                    IF DROP 0 GX ! 10 GY +!                                         ELSE GEMIT                                                      THEN                                                          REPEAT                                                          DROP ;                                                                                                                       : Z                                                               0 0 GXYTAB EMITS-INIT ;                                                                                                                                                                                                                              ( fah  )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ( character size notes                           <11/ 8/89>220) EXIT --------------------------------------------------------                                                                   This code is functionaly identical to IBM except the following  used functionality has been removed:                                                                                              -- Italics, Teletype (might install later)                      -- Bullets (markers)                                            -- Wait and View page                                           -- Underline color holds color number not color mask            -- PARAMS table accessed directly                                                                                                                                                                                                                                                                                                                                                    ( fah  )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ( -CSIZE-                                        <11/ 9/89>222)                                                                 ONLY FORTH ALSO DEFINITIONS                                                                                                       VOCABULARY -CSIZE- IMMEDIATE                                                                                                  ONLY FORTH ALSO -CSIZE- ALSO FORTH DEFINITIONS                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ( fah  ) ( PARAMETER TABLE                                <11/ 9/89>223) EXIT \ defined in CEMITS.SCR                                                                                                    CREATE PARAMS \ temporary emits parameters for CSIZE              2 ALLOT \  0: Current character                                 4 ALLOT \  2: Temp character set pointer                        2 ALLOT \  6: Temp font number                                  2 ALLOT \  8: Temp old font number                              2 ALLOT \ 10: Temp font offset                                  2 ALLOT \ 12: Temp num extra pixels to add to width             2 ALLOT \ 14: Temp num extra pixels to add to height            2 ALLOT \ 16: Temp italics increment                            2 ALLOT \ 18: Temp italics offset                               2 ALLOT \ 20: Temp height of a blank line                       2 ALLOT \ 22: Temp fixed line ht                                                                                     ( fah  ) ( PARAMETER TABLE                                <11/ 9/89>224) EXIT \ defined in CEMITS.SCR                                                                                                      2 ALLOT \ 24: Temp kerning                                      2 ALLOT \ 26: Temp leading                                      2 ALLOT \ 28: Temp underline offset                             2 ALLOT \ 30: Temp last control code                            2 ALLOT \ 32: Temp space to add before next character                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ( fah  ) ( {tfont#}                                       <11/ 9/89>225) -CSIZE- DEFINITIONS                                                                                                             SUBR {tfont#} \ switch to font .A                                 PARAMS 6 + ,X STA,           \ FONT# = A                        .A ASL, TAY,                  \ Y=font# * 2                     FONT-TABLE ,Y LDA,            \ lobyte of font offset           PARAMS 2 + STA,                                                 INY, FONT-TABLE ,Y LDA,       \ hibyte of font offset           PARAMS 3 + STA,                                                 ' FONT:SEG LDA,               \ lobyte of font segment          PARAMS 4 + STA,                                                 ' FONT:SEG 1+ LDA,            \ hibyte of font segemtn          PARAMS 5 + STA,                                                 RTS, S;                                                                                                              ( fah  ) ( TDO-NO TDO-CTRL                                <11/ 9/89>226) -CSIZE- DEFINITIONS                                                                                                             CREATE DRT \ dummy routine, a simple return                        ASSEMBLER RTS,                                                                                                               CREATE TDO-NO \ routines to run control with no args (1-6)         DRT , DRT , DRT , DRT , DRT , DRT ,                                                                                          CREATE TDO-CTRL \ routines to run ctrl codes with args (14-31)     DRT , DRT , DRT , DRT , DRT , DRT , DRT ,                       DRT , DRT , DRT , DRT , DRT , DRT , DRT ,                       DRT , DRT , DRT , DRT , DRT , DRT , DRT ,                                                                                                                                                                                                           ( fah  ) ( TROUTINES:  1 - Restore defaults               <11/ 9/89>227)   \ all routines assume BP points to paramter table             -CSIZE- DEFINITIONS                                                                                                             SUBR CROUTINES                                                    HERE TDO-NO !                                                   # 0 LDA, PARAMS 12 + STA,     \ TWEXTRA=0                       PARAMS 14 + STA,              \ THEXTRA=0                       PARAMS 18 + STA,              \ TI-OFS=0                          \ this falls through to the next piece of code                  \ which completes the initialization process                                                                                  ?CSP \ catch errors when they happen                          EXIT                                                                                                                                                                                   ( fah  ) (  2: Restore default font                       <11/ 9/89>228)                                                                 HERE TDO-NO 2+ !                                                   PARAMS 8 + LDA, {tfont#} JSR,   \ set previous font#         \  BX, 16 [BP] MOV BX, BX OR       \ check TI-INC               \  IF= not \ if not zero update twlast to maintain italics      \   AX, 10 [BP] CWD BX IDIV        \ AX = TFONTOFS / TI-INC     \   AX, 32 [BP] ADD AX INC         \ AX = AX+TWLAST + 1         \   32 [BP], AX MOV                \ TWLAST = AX                \  THEN                                                            # 0 LDA, PARAMS 10 + STA,       \ TFONTOFS = 0                  RTS, ?CSP                       \ done, return and check                                                                                                                                                                                                                                                                     (  3: start teletype mode                        <11/ 9/89>229)                                                                 EXIT                                                                                                                            This command has no effect on line size and is ignored                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ( fah  ) (  4 & 5: Set temp margins at current position   <11/ 9/89>230)                                                                 EXIT                                                                                                                            This command has no effect on line size for the current line    and is ignored. DTEXT uses values set by these codes            when computing line length.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ( fah  ) ( 14: switch to temp font m, n pixels above top  <11/ 9/89>231)                                                                 HERE TDO-CTRL ! \ set jump table                                   PARAMS 6 + LDA, PARAMS 8 + STA,   \ save current font           PARAMS LDA, .A LSR, .A LSR,       \ bits 3-5 are font#          .A LSR, # 7 AND, {tfont#} JSR,    \ set new font                PARAMS LDA, # 7 AND,              \ bits 0-2 are amount above   zptr STA, SEC, # 0 LDA,           \ no negate on 6502           zptr SBC, DPARAMS 10 + STA,       \ FONTOFS=0-n              RTS,                                                                                                                            ?CSP \ catch errors when they happen                                                                                                                                                                                                                                                                                   ( fah  ) ( 15: switch to temp font m, n pixels below bot  <11/ 9/89>232)                                                                 HERE TDO-CTRL 2+ ! \ set jump table                                PARAMS 6 + LDA, PARAMS 8 + STA,    \ save current font          PARAMS 2+ LDA, zptr STA,           \ move font ptr to zpage     PARAMS 3 + LDA, zptr 1+ STA,                                    # 8 LDY, zptr ,Y LDA, PHA,         \ save old basel             PARAMS LDA, .A LSR, .A LSR,        \ bits 3-5 are font#         .A LSR, # 7 AND, {tfont#} JSR,     \ set new font                                                                            \ more...                                                                                                                                                                                                                                                                                                                                                                              ( fah  ) ( 15: cont                                       <11/ 9/89>233)                                                                    PARAMS LDA, # 7 AND, zptr STA,   \ bits 0-2 are amount below    PLA, CLC, zptr ADC,              \ zptr.A = n + oldbasel        PARAMS 2+ LDY, zptr STY,         \ move font ptr to zpage       PARAMS 3 + LDY, zptr 1+ STY,                                    # 8 LDY, SEC, zptr )Y SBC,       \ .A = .A - newbasel           PARAMS 10 + STA,                 \ FONTOFS = .A                 RTS,                             \ done                                                                                      ?CSP \ catch errors when they happen                                                                                                                                                                                                                                                                                                                                                   ( fah  ) ( 16: Set default font to n                      <11/ 9/89>234)                                                                 HERE TDO-CTRL 4 + !                                                PARAMS LDA, # 15 AND,         \ bits 0-3 are font num           {tfont#} JSR,                                                   # 0 LDA, PARAMS 10 + STA,     \ FONTOFS = 0                     RTS,                                                                                                                         ?CSP \ done, return and check                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ( fah  ) ( 17: Set text color                             <11/ 9/89>235)                                                                 EXIT                                                                                                                            Setting text color has no impact on character spacing so        nothing is planted, the main loop will call the dummy return    that was planted when the table was created                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ( fah  ) ( 18: Set kerning to n                           <11/ 9/89>236)                                                                 HERE TDO-CTRL 8 + !                                                PARAMS LDA, # 15 AND,            \ bits 0-3 are kerning         PARAMS 24 + STA,                 \ CDX = 0                      RTS, ?CSP                        \ done, return and check                                                                                                                                    EXIT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ( fah  ) ( 19: Strart underlining n pixs below baseline   <11/ 9/89>237)                                                                 HERE TDO-CTRL 10 + !                                               PARAMS LDA, # 7 AND,              \ bits 0-2 pixs below base    PARAMS 28 + STA,                  \ TUOFS = n                                                                                   RTS, ?CSP                         \ done, return and check                                                                   EXIT                                                                                                                            Color (bits 3-5) is ignored for obvious reasons                                                                                                                                                                                                                                                                                                                                        ( fah  ) ( 20: Start bold printing                        <11/ 9/89>238)                                                                 HERE TDO-CTRL 12 + !                                               \ don't care which colors we know that bold                     \ adds one to width and nothing to height                       # 1 LDA, PARAMS 12 + STA,         \ TWEXTRA=1                   # 0 LDA, PARAMS 14 + STA,         \ THEXTRA=0                                                                                   RTS,  ?CSP                        \ done, return and check                                                                   EXIT                                                                                                                                                                                                                                                                                                                                                                                   ( fah  ) ( 21: Start shadow printing                      <11/ 9/89>239)                                                                 HERE TDO-CTRL 14 + !                                               \ don't care which colors we know that shadow                   \ adds one to width and one to height                           # 1 LDA, PARAMS 12 + STA,         \ TWEXTRA=1                            PARAMS 14 + STA,         \ THEXTRA=1                   RTS,  ?CSP                        \ done, return and check                                                                   EXIT                                                                                                                                                                                                                                                                                                                                                                                                                                                   ( fah  ) ( 22: Set leading                                <11/ 9/89>240)                                                                 HERE TDO-CTRL 16 + !                                               PARAMS LDA, # 15 AND,             \ bits 0-3 are leading        PARAMS 26 + STA,                  \ TCDY = n                                                                                    RTS, ?CSP                         \ done, return and check                                                                   EXIT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ( fah  ) ( 23: Set italics                                <11/ 9/89>241)                                                                 EXIT -------------- not implemented ----------------                                                                            HERE TDO-CTRL 18 + !                                               AX, [BP] MOV AX, # 3 AND         \ bits 0-1 are lean amount     16 [BP], AX MOV                  \ TI-INC = n                   AX, # 0 MOV 18 [BP], AX MOV      \ TI-OFS = 0                                                                                   RET ?CSP                          \ done, return and check                                                                   EXIT                                                                                                                                                                                                                                                                                                                   ( fah  ) ( 24: Set fixed line heigth                      <11/ 9/89>242)                                                                 HERE TDO-CTRL 20 + !                                               PARAMS LDA, # 31 AND,             \ bits 0-4 are line height    PARAMS 22 + STA,                  \ TLINE-HT = n                ' SHEIGHT STA,                    \ SHEIGHT = n                                                                                 RTS, ?CSP                         \ done, return and check                                                                   EXIT                                                                                                                            NOTE - SRISE is still computed. It should be ignored on lines     except the first line in a window (so chars don't exetend       above top margin)                                                                                                                                                                    ( fah  ) ( 25: Set blank line heigth                      <11/ 9/89>243)                                                                 HERE TDO-CTRL 22 + !                                               ' SWIDTH LDA, 0=                  \ no width yet?               IF, ' SWIDTH 1+ LDA, 0=                                          IF, PARAMS LDA, # 31 AND,        \ bits 0-4 are line height      ' SHEIGHT STA,                  \ SHEIGHT = n                  THEN,                                                          THEN,                                                           RTS, ?CSP                         \ done, return and check                                                                   EXIT                                                            If there are no characters printed update SHEIGHT otherwise     ignore the value                                                                                                                                                                                ( 26: set print mode                             <11/ 9/89>244)                                                                 EXIT                                                                                                                            HERE TDO-CTRL 24 + !                                                                                                            does not affect text size no code needed                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               ( fah  ) ( 27: view screen                                <11/ 9/89>245)                                                                 EXIT                                                                                                                            HERE TDO-CTRL 26 + !                                                                                                                                                                            does not affect text size no code needed                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               ( fah  ) ( 28: Display a marker                           <11/ 9/89>246) EXIT ---------- not implemented ------------                                                                                    HERE TDO-CTRL 28 + !                                               \ add 2*baseline position to width                              BX, 2 [BP] MOV DS, 4 [BP] MOV     \ DS:BX points to set         AL, 8 [BX] MOV                    \ get baseline pos            CBW AX, 1 SHL                     \ *2                          CS: ' SWIDTH , AX ADD             \ SWIDTH += AX                                                                                RET ?CSP                          \ done, return and check   EXIT                                                            Both parameters are ignored as they do not effect size          The totla width of a marker is 2 * baseline height of the set                                                                                                                          ( fah  ) ( 29: Print char without translation             <11/ 9/89>247)                                                                 EXIT                                                                                                                            HERE TDO-CTRL 30 + !                                                                                                              --- see note at the bottom of {addsize} ----                                                                                  Basically, {addsize} is called directly with the parameter      so it is added to the width without trying to interpret         it as a control code                                                                                                                                                                                                                                                                                                                                                                   ( fah  ) ( 30: Mark current position to table n           <11/ 9/89>248)                                                                 EXIT                                                                                                                            HERE TDO-CTRL 32 + !                                                                                                            No action is required as the command has no effect on spacing                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ( fah  ) ( {tcofs}                                        <11/ 9/89>249) -CSIZE- DEFINITIONS                                             VARIABLE tcbasel       ( base line of font )                    SUBR {tcofs} \ Set GFIG to point to char .A CS=not defined         PHA, PARAMS 2+ LDA, GFIG STA, \ GFIG=char set start             PARAMS 3 + LDA, GFIG 1+ STA,                                    # 8 LDY, GFIG )Y LDA, tcbasel STA, \ save baseline for later    PLA, # 2 LDY, SEC, GFIG )Y SBC, CS NOT \ make ofs to char ptr   IF, SEC, RTS, THEN,               \ before 1st, return err      .A ASL, CLC, # 16 ADC, TAY,       \ Y=ofs to char pointer       GFIG )Y LDA, 0=                   \ if lobyte is zero           IF, INY, GFIG )Y LDA, 0=          \ and hibyte is zero           IF, SEC, RTS, ( return error )   \ not defined, exit            THEN, DEY,                       \ point back to lobyte        THEN,                                                        \ more...                                              ( fah  ) ( {tcofs}                                        <11/ 9/89>250)                                                                     \ add offset of character to table start                       CLC, GFIG ADC, TAX,                                             INY, GFIG )Y LDA,                                               GFIG 1+ ADC,                                                    GFIG 1+ STA, GFIG STX,                                           \ gfig now points to character data                            CLC, ( no error )                                               RTS,                                                         S;                                                                                                                                                                                                                                                                                                                                                                                              ( {tcwidth}                                      <11/ 9/89>251) -CSIZE-                                                                                                                         \ call: GFIG points to char data (set by {tcofs})               \  ret: .A = width                                              SUBR {tcwidth} \ assumes that char in AX is defined                # 0 LDY,                 \ wid is 1st byte of char data         GFIG )Y LDA,                                                 RTS, S;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ( fah  ) ( {TCWIDTH} TCWIDTH                              <11/ 9/89>252) ROOT -CSIZE- FORTH                                                                                                              SUBR {TCWIDTH} ( .A=C --> .A=width, X=TCDX )                      {tcofs} JSR, CS NOT          \ get offset to char, valid?       IF, {tcwidth} JSR,           \ yes, get width                   ELSE, # 0 LDA, THEN,         \ no, return zero                  PARAMS 24 + LDX,             \ get TCDX                         RTS, S;                                                                                                                       CODE TCWIDTH ( C -- WIDTH )                                       BOT LDA, BOT 1+ STY, XSAVE STX,                                 {TCWIDTH} JSR, XSAVE LDX, BOT STA,                              NEXT JMP, C;                                                                                                                                                                         ( fah  ) ( {tcheight}                                     <11/ 9/89>253) -CSIZE- DEFINITIONS                                                                                                             \ call: GFIG points to char data (set by {tcofs})               \  ret: .A = width                                              SUBR {tcheight}                                                    \ assumes someone else checked that the AX is defined           # 1 LDY,                 \ ht is 2nd byte of char data          GFIG )Y LDA,                                                 RTS, S;                                                                                                                                                                                                                                                                                                                                                                                                                                                ( fah  ) ( {addwid}                                       <11/ 9/89>254) -CSIZE- DEFINITIONS                                                                                                             \ call: GFIG points to char data (set by {tcofs})               SUBR {addwid} \ add width values for character                    {tcwidth} JSR,                      \ .A = width of char        CLC, PARAMS 12 + ADC,               \ .A += TWEXTRA             CLC, PARAMS 32 + ADC,               \ .A += TWLAST              CLC, ' SWIDTH ADC, ' SWIDTH STA,    \ SWIDTH += AX              # 0 LDA, ' SWIDTH 1+ ADC, ' SWIDTH 1+ STA,                      PARAMS 24 + LDA,                    \ TWLAST = TCDX             PARAMS 32 + STA,                                              RTS, S;                                                                                                                                                                                                                                                ( fah  ) ( {addht}                                        <11/ 9/89>255) -CSIZE- DEFINITIONS                                                                                                             \ call: GFIG points to char data (set by {tcofs})               SUBR {addht} \ add height values for character                    PARAMS 22 + LDA, # 0 CMP, 0= NOT    \ is fixed LINE-HT <> 0?    IF, ' SHEIGHT STA, RTS, THEN,       \ yes, SHEIGHT = LINE-HT    {tcheight} JSR,                     \ .A = height of char       CLC, PARAMS 14 + ADC,               \ .A += THEXTRA             CLC, PARAMS 10 + ADC,               \ .A += TFONTOFS            zptr STA,  ( save for later )                                                                                                                                                                                                                                                                                                                                                        ( fah  ) ( {addht} cont                                   <11/ 9/89>256)                                                                   tcbasel LDA,                        \ .A = baseline             SEC, PARAMS 8 + ADC,                \ .A += TUOFS + 1           CLC, PARAMS 10 + ADC,               \ .A += TFONTOFS            zptr CMP, 0<                        \ take max of .A, zptr      IF, zptr LDA, THEN,                                             ' SHEIGHT CMP, 0<                   \ bigger than last ht?      IF, ' SHEIGHT STA, THEN,                                      RTS, S;                                                                                                                                                                                                                                                                                                                                                                                                                                                ( fah  ) ( {comprise}                                     <11/ 9/89>257) -CSIZE- DEFINITIONS                                                                                                             \ call: GFIG points to char data (set by {tcofs})               SUBR {comprise}  \ compute SRISE                                  # 0 LDA, SEC, PARAMS 10 + SBC, CS NOT \ 0-TFONTOFS > 0?         IF, ' SRISE CMP, 0< NOT             \ bigger than last rise?     IF, ' SRISE STA,                                                THEN,                                                          THEN,                                                           RTS, S;                                                                                                                                                                                                                                                                                                                                                                                       ( {tstart-italics?}                              <11/ 9/89>258) -CSIZE- DEFINITIONS                                                                                                             \ call: DS:BX+SI points to char data (set by {tcofs})           SUBR {tstart-italics?} RTS, S;                                  EXIT ----------------------------------------------------         AX, 16 [BP] MOV AX, AX OR               \ italics on?           IF= not AX, 18 [BP] MOV AX, AX OR       \ offset not set?        IF= AL, 8 [BX] MOV AH, AH XOR          \ AX = base line pos      CWD WORD 16 [BP] IDIV                 \ AX = AX / TI-INC        32 [BP], AX ADD                       \ TWLAST += AX            18 [BP], AX MOV                       \ TI-OFS = AX            THEN                                                           THEN                                                            RET C;                                                                                                               ( fah  ) ( {addsize}                                      <11/ 9/89>259) -CSIZE- DEFINITIONS                                             SUBR {addsize} \ call: char in PARAMS C@                           PARAMS LDA,                        \ get current char           {tcofs} JSR, CS NOT                \ is char defined?           IF,                                                              {tstart-italics?} JSR,                                          {addwid} JSR,                                                   {addht} JSR,                                                    {comprise} JSR,                                                THEN,                                                           RTS, S;                                                      {addsize} TDO-CTRL 30 + !                                       \ 29: Print char without translation simply calls addsize       \ with its parameter so I just plant {addsize} in table                                                                ( fah  ) ( {docsize}                                      <11/ 9/89>260) -CEMITS- DEFINITIONS                                                                                                            SUBR {docsize} ( -- )                                              \ first check if this byte is a params to last control code     PARAMS 30 + LDA, 0= NOT         \ last ctrl w/params?           IF, 0 # LDX, PARAMS 30 + STX,   \ clear flag,                    SEC, # 14 SBC, .A ASL,         \ (last code - 14) * 2           CLC, # TDO-CTRL LOBYTE ADC,    \ + TDO-CTRL                     HERE 11 + STA,            \ ** set indirect jump AHEAD!! **     # TDO-CTRL HIBYTE LDA, 0 # ADC,                                 HERE 5 + STA,             \ ** set indirect jump AHEAD!! **     108 C, 0 C, 1 C,          \ indirect jump                      THEN,                                                        EXIT MORE...                                                                                                           ( fah  ) ( {docsize} cont                                 <11/ 9/89>261)                                                                    \ now check if this is a control with no parameters (1-6)       PARAMS LDA, SEC, # 1 SBC, CS     \ is char >= 1?                IF, # 6 CMP, CS NOT              \ and less than 6?              IF, .A ASL,               \ yes run ctrl w/no params             CLC, # TDO-NO LOBYTE ADC,                                       HERE 11 + STA,           \ ** set indirect jump AHEAD!! **      # TDO-NO HIBYTE LDA, 0 # ADC,                                   HERE 5 + STA,            \ ** set indirect jump AHEAD!! **      108 C, 0 C, 1 C,         \ indirect jump                       THEN,                                                          THEN,                                                                                                                        EXIT MORE ....                                                                                                         ( fah  ) ( {docsize} cont                                 <11/ 9/89>262)                                                                    \ now check if this is a control with paramers (14-31)          PARAMS LDA, # 14 CMP, CS        \ is char >= 14?                IF, # 32 CMP, CS NOT            \ and less than 32?              IF, PARAMS 30 + STA,           \ save char in TCTRL               RTS,                                                          THEN,                                                          THEN,                                                           \ if we get here we should just print the character             {addsize} JMP, S;                                                                                                            EXIT MORE ....                                                                                                                                                                                                                                         ( fah  ) ( {csize} CSIZE                                  <11/ 9/89>263) FORTH DEFINITIONS                                                                                                               SUBR {csize} \ .A=char, X,Y altered                               PARAMS STA,                    \ save char in table             {docsize} JSR,                                                  RTS, S;                                                                                                                       CODE CSIZE ( C -- )                                               BOT LDA, XSAVE STX,                                             {csize} JSR,                                                    XSAVE LDX, POP JMP, C;                                                                                                                                                                                                                                                                                               ( fah  ) ( STRLEN                                         <11/ 9/89>264) FORTH DEFINITIONS                                                                                                               : STRLEN ( str --, run string through CSIZE )                      CS-INIT COUNT 0                                                 DO COUNT CSIZE LOOP                                             DROP ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ( fah  ) ( CDX ?CNUM COFS                                 <11/ 9/89>265) FORTH DEFINITIONS                                                                                                               : CDX ( -- n, return current character spacing )                   DPARAMS 24 + ;                                                                                                               : CSET ( -- la, return base pointer of current set )               DPARAMS 2+ ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ( fah  ) ( ?CNUM COFS                                     <11/ 9/89>266) FORTH DEFINITIONS                                                                                                               : ?CNUM ( C -- T/F, return true if char in range )                 CSET @ 2+ @ CSET @ 4 + @ 1- WITHIN ;                                                                                         : COFS ( C -- ofs, return offset of character data from CSET)      DUP ?CNUM                                                       IF CSET @ 2+ @ - 2* 16 +     ( offset to character pointer)       CSET @ + @                 ( offset of character data )       ELSE DROP 0 THEN ;                                                                                                                                                                                                                                                                                                                                                                  ( fah  ) ( CWIDTH CHEIGHT                                 <11/ 9/89>267) FORTH DEFINITIONS                                                                                                               : CWIDTH ( C -- W, pixel width including CDX)                      COFS DUP                     ( if not defined return 0 )        IF CSET @ + C@ CDX @ + THEN ;                                                                                                : CHEIGHT ( C -- H, line heigth not including CDY )                COFS DUP                                                        IF CSET @ + 1+ C@ THEN ;                                                                                                                                                                                                                                                                                                                                                                                                                            ( fah  )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (                                                <11/ 9/89>270)                                                                 : .C                                                              SWIDTH . SHEIGHT . SRISE . ;                                  : Q CSIZE .C ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ( fah  )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 